<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดตารางสอนแทน O-NET</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <!-- html2canvas library for exporting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Style the date picker icon */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.6) sepia(0.5) saturate(5) hue-rotate(200deg);
        }
        /* Style for the buttons */
        .action-button {
            @apply inline-flex items-center justify-center px-5 py-2.5 text-base font-medium text-center text-white rounded-lg shadow-md transition duration-150 ease-in-out focus:ring-4 focus:outline-none;
        }
        .export-button {
             @apply bg-green-600 hover:bg-green-700 focus:ring-green-300;
        }
        .share-button {
             @apply bg-blue-600 hover:bg-blue-700 focus:ring-blue-300;
        }
         /* Simple toast notification style */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1000;
            max-width: 90%;
            text-align: center;
        }
        #toast.show {
            opacity: 1;
        }
        /* Ensure the date input itself is centered */
        #date-picker-container {
            display: flex;
            justify-content: center;
        }
        input[type="date"] {
             @apply w-auto max-w-xs p-3 border border-slate-300 rounded-lg text-lg text-center shadow-sm focus:ring-indigo-500 focus:border-indigo-500;
        }
        /* Tab Styles */
        .tab-button {
            @apply px-4 py-2 text-lg font-medium border-b-2 border-transparent hover:border-indigo-500 hover:text-indigo-600 focus:outline-none transition duration-150 ease-in-out;
        }
        .tab-button.active {
            @apply border-indigo-500 text-indigo-600;
        }
        .tab-content {
            display: none; /* Hidden by default */
        }
        .tab-content.active {
            display: block; /* Shown when active */
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="min-h-screen p-4 md:p-8">
        <!-- Main container -->
        <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-lg">
            <h1 class="text-3xl font-bold text-center text-indigo-800 mb-6">
                ระบบจัดตารางสอนแทน O-NET
            </h1>

            <div class="mb-8 text-center">
                <label for="date-picker" class="block text-lg font-medium text-slate-700 mb-3">
                    กรุณาเลือกวันที่
                </label>
                <div id="date-picker-container">
                    <input
                        type="date"
                        id="date-picker"
                        value="2025-11-10" <!-- Set default date -->
                    >
                </div>
            </div>

             <!-- Action Buttons -->
             <div class="flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4 mb-8">
                <button id="export-btn" class="action-button export-button w-full sm:w-auto">
                    <i class="fas fa-file-export mr-2"></i> Export ตารางเรียน (JPG)
                </button>
                <button id="share-btn" class="action-button share-button w-full sm:w-auto">
                   <i class="fas fa-share-square mr-2"></i> แชร์ตารางเรียน
                </button>
				<button id="export-combined-btn" class="action-button bg-purple-600 hover:bg-purple-700 focus:ring-purple-300 w-full sm:w-auto mt-3 sm:mt-0 sm:ml-4">
                    <i class="fas fa-images mr-2"></i> Export ภาพพิเศษ (รวม)
                </button>
				<button id="share-combined-btn" class="action-button bg-teal-600 hover:bg-teal-700 focus:ring-teal-300 w-full sm:w-auto mt-3 sm:mt-0 sm:ml-4">
                    <i class="fas fa-share-alt mr-2"></i> แชร์ภาพพิเศษ (รวม)
                </button>
            </div>

<div class="mt-8 text-center">
                <label class="block text-lg font-medium text-slate-700 mb-3">
                    <i class="fas fa-sync-alt mr-2"></i> โหมดหมุนวนตารางติว O-NET
                </label>
                <div class="flex justify-center items-center space-x-4">
                    <button id="prev-rotation-btn" class="action-button bg-slate-500 hover:bg-slate-600 focus:ring-slate-300 w-16">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="rotation-status" class="text-lg font-semibold text-indigo-700 w-32">
                        รูปแบบ 1 / 4
                    </span>
                    <button id="next-rotation-btn" class="action-button bg-slate-500 hover:bg-slate-600 focus:ring-slate-300 w-16">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <hr class="my-8" />

            <!-- Tabs -->
            <div class="mb-4 border-b border-gray-200">
 <nav class="-mb-px flex justify-center space-x-8" aria-label="Tabs">
    <button id="tab-teacher" class="tab-button active" data-tab="teacher-schedule">
        ตารางสอนแทน (สำหรับครู)
    </button>
    <button id="tab-student" class="tab-button" data-tab="student-schedule">
        ตารางเรียน (สำหรับนักเรียน)
    </button>
		<button id="tab-substitute-summary" class="tab-button" data-tab="substitute-summary-schedule">
        <i class="fas fa-user-clock mr-2"></i> สรุปการสอนแทน
    </button>
    <button id="tab-summary" class="tab-button" data-tab="summary">
        <i class="fas fa-chart-bar mr-2"></i> สรุปชั่วโมงสอน
    </button>
	<button id="tab-onet-overview" class="tab-button" data-tab="onet-overview">
        <i class="fas fa-calendar-alt mr-2"></i> ภาพรวมตารางติว
    </button>
</nav>
            </div>

            <!-- Tab Content Area -->
            <div>
                <!-- Teacher Schedule Content -->
                <div id="teacher-schedule-content" class="tab-content active space-y-6 bg-white p-1">
                    <h3 id="teacher-schedule-header" class="text-2xl font-bold text-center text-indigo-700 mb-6"></h3>
                    <div id="teacher-schedule-details">
                         <!-- Teacher details will be rendered here -->
                    </div>
                    <p id="teacher-schedule-nodata" class="text-center text-slate-500 text-xl font-medium py-8 hidden"></p>
                </div>

                <!-- Student Schedule Content -->
<div id="student-schedule-content" class="tab-content space-y-6 bg-white p-1">
   <h3 id="student-schedule-header" class="text-2xl font-bold text-center text-indigo-700 mb-6"></h3>
   <div id="student-schedule-details">
       </div>
   <p id="student-schedule-nodata" class="text-center text-slate-500 text-xl font-medium py-8 hidden"></p>
</div>

        <div id="summary-content" class="tab-content space-y-6 bg-white p-1">
           <h3 id="summary-schedule-header" class="text-2xl font-bold text-center text-indigo-700 mb-6"></h3>
           <div id="summary-schedule-details" class="overflow-x-auto">
               </div>
           <p id="summary-schedule-nodata" class="text-center text-slate-500 text-xl font-medium py-8 hidden"></p>
        </div>
<div id="onet-overview-content" class="tab-content bg-white p-1">
           <h3 id="onet-overview-header" class="text-2xl font-bold text-center text-indigo-700 mb-6">ภาพรวมตารางติว O-NET ปีการศึกษา 2568</h3>
           <div id="onet-overview-details" class="overflow-x-auto">
               </div>
           <p id="onet-overview-nodata" class="text-center text-slate-500 text-xl font-medium py-8 hidden"></p>
        </div>
		<div id="substitute-summary-schedule-content" class="tab-content space-y-6 bg-white p-1">
           <h3 id="substitute-summary-schedule-header" class="text-2xl font-bold text-center text-indigo-700 mb-6"></h3>
           <div id="substitute-summary-schedule-details" class="space-y-4">
               {/**/}
           </div>
           <p id="substitute-summary-schedule-nodata" class="text-center text-slate-500 text-xl font-medium py-8 hidden"></p>
        </div>
    </div>
    </div>
            </div>

        </div>
    </div>

    <!-- Toast Notification Element -->
    <div id="toast">ข้อความแจ้งเตือน</div>

    <script>
        // --- DATABASE: O-NET Schedule (Updated Times) ---
        const originalOnetData = {
          "10/11/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
          "11/11/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
           "12/11/2568": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
          "13/11/2568": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "14/11/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
          // ... (Rest of the onetData remains the same) ...
           "17/11/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
          "18/11/2568": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
          "19/11/2568": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "20/11/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
          "21/11/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
           "24/11/2568": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
          "25/11/2568": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "26/11/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
          "27/11/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
          "28/11/2568": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
          "01/12/2568": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "02/12/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
          "03/12/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
          "04/12/2568": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
          "08/12/2568": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "09/12/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
           "11/12/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
          "12/12/2568": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
          "15/12/2568": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "16/12/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
          "17/12/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
          "18/12/2568": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
           "19/12/2568": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "22/12/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
          "23/12/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
          "24/12/2568": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
          "25/12/2568": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
           "29/12/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
          "30/12/2568": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
          "31/12/2568": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
          "06/01/2569": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "07/01/2569": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
           "08/01/2569": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
          "09/01/2569": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
          "12/01/2569": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "13/01/2569": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
          "14/01/2569": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
           "15/01/2569": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
          "16/01/2569": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "20/01/2569": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
          "21/01/2569": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
          "22/01/2569": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
           "23/01/2569": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "26/01/2569": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ],
          "27/01/2569": [
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '12:30 - 16:00 น.' }
          ],
          "28/01/2569": [
            { periods: [1, 2, 3], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '12:30 - 16:00 น.' }
          ],
          "29/01/2569": [
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ป.6', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ป.6', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ม.3', teacher: 'ครูสายรุ้ง เรืองสุขสุด', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ม.3', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' }
          ],
          "30/01/2569": [
            { periods: [1, 2, 3], subject: 'ภาษาอังกฤษ', grade: 'ป.6', teacher: 'ครูอรุณลักษณ์ การกระสัง', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'คณิตศาสตร์', grade: 'ป.6', teacher: 'ครูอมรเทพ จันทร์ครบ', time: '12:30 - 16:00 น.' },
            { periods: [1, 2, 3], subject: 'วิทยาศาสตร์', grade: 'ม.3', teacher: 'ครูณัฐชนม์ วงศ์มา', time: '08:00 - 11:30 น.' },
            { periods: [4, 5, 6], subject: 'ภาษาไทย', grade: 'ม.3', teacher: 'ครูดำเนิน ว่าดี', time: '12:30 - 16:00 น.' }
          ]
        };
		
		// --- 2. เพิ่มตัวแปรสำหรับโหมดหมุนวน ---
        let onetData = originalOnetData; // ตัวแปรนี้คือข้อมูล O-NET ที่จะใช้จริง (หมุนวนได้)
        let currentRotationIndex = 0;
        
        // ดึงวันที่ทั้งหมดมาเรียงลำดับ
        const onetDateKeys = Object.keys(originalOnetData).sort((a, b) => dateKeyToDate(a) - dateKeyToDate(b)); //
        
        // เก็บ 4 รูปแบบตารางติวหลัก (จาก 4 วันแรก)
        const onetSchedulePatterns = [
            originalOnetData["10/11/2568"], // รูปแบบ 1 (E, M, S, T)
            originalOnetData["11/11/2568"], // รูปแบบ 2 (T, S, M, E)
            originalOnetData["12/11/2568"], // รูปแบบ 3 (M, E, T, S)
            originalOnetData["13/11/2568"]  // รูปแบบ 4 (S, T, E, M)
        ];
        // --- สิ้นสุดส่วนที่เพิ่ม ---

        // --- DATABASE: Teacher Data & Schedules ---
        const allTeacherData = [
          // --- ครูติว O-NET ---
          {
            name: 'ครูณัฐชนม์ วงศ์มา',
            type: 'tutor',
            canTeachGrades: [],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: 'วิทยาศาสตร์และเทคฯ', grade: 'ม.1' },
                { period: 2, subject: 'วิทยาศาสตร์และเทคฯ 6', grade: 'ป.6' },
                { period: 3, subject: 'วิทยาศาสตร์และเทคฯ 4', grade: 'ป.4' },
                { period: 4, subject: 'ซ่อมเสริม', grade: 'ป.5' },
                { period: 5, subject: 'วิทยาศาสตร์และเทคฯ', grade: 'ม.2' },
                { period: 6, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.5' }
              ],
              'วันอังคาร': [
                { period: 1, subject: 'วิทยาศาสตร์และเทคฯ 4', grade: 'ป.4' },
                { period: 2, subject: 'วิทยาศาสตร์และเทคฯ', grade: 'ม.2' },
                { period: 3, subject: 'วิทยาศาสตร์และเทคฯ 5', grade: 'ป.5' },
                { period: 4, subject: 'วิทยาศาสตร์และเทคฯ', grade: 'ม.1' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: null, grade: null }
              ],
              'วันพุธ': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'วิทยาศาสตร์และเทคฯ 6', grade: 'ป.6' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'วิทยาศาสตร์ฯ (เพิ่มเติม)', grade: 'ม.1' },
                { period: 5, subject: 'วิทยาศาสตร์และเทคฯ', grade: 'ม.3' },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: 'วิทยาศาสตร์และเทคฯ', grade: 'ม.3' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'สุขศึกษาและพลศึกษา 5', grade: 'ป.5' },
                { period: 4, subject: 'สุขศึกษาและพลศึกษา 4', grade: 'ป.4' },
                { period: 5, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.5' },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: 'วิทยาศาสตร์ฯ (เพิ่มเติม)', grade: 'ม.2' },
                { period: 2, subject: 'วิทยาศาสตร์ฯ (เพิ่มเติม)', grade: 'ม.3' },
                { period: 3, subject: 'วิทยาศาสตร์และเทคฯ 5', grade: 'ป.5' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'PLC', grade: null }
              ]
            }
          },
          {
            name: 'ครูดำเนิน ว่าดี',
            type: 'tutor',
            canTeachGrades: [],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: 'ภาษาไทย 6', grade: 'ป.6' },
                { period: 2, subject: 'ศิลปะ (ทัศนศิลป์)', grade: 'ม.3' },
                { period: 3, subject: 'ภาษาไทย', grade: 'ม.1' },
                { period: 4, subject: 'ภาษาไทย', grade: 'ม.2' },
                { period: 5, subject: 'ภาษาไทย', grade: 'ม.3' },
                { period: 6, subject: 'ศิลปะ (ดนตรี)', grade: 'ม.1' }
              ],
              'วันอังคาร': [
                { period: 1, subject: 'ภาษาไทย 6', grade: 'ป.6' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'ภาษาไทย', grade: 'ม.1' },
                { period: 4, subject: 'ภาษาไทย', grade: 'ม.3' },
                { period: 5, subject: 'ศิลปะ (ดนตรี)', grade: 'ม.3' },
                { period: 6, subject: 'แนะแนว', grade: 'ป.6' }
              ],
              'วันพุธ': [
                { period: 1, subject: 'ภาษาไทย', grade: 'ม.1' },
                { period: 2, subject: 'ภาษาไทย', grade: 'ม.3' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'ศิลปะ (ทัศนศิลป์)', grade: 'ม.2' },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: 'ภาษาไทย 6', grade: 'ป.6' },
                { period: 2, subject: 'ภาษาไทย', grade: 'ม.2' },
                { period: 3, subject: 'ศิลปะ (ดนตรี)', grade: 'ม.2' },
                { period: 4, subject: 'วิทยาการคำนวณ 6', grade: 'ป.6' },
                { period: 5, subject: 'ศิลปะ (ทัศนศิลป์)', grade: 'ม.1' },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: 'ภาษาไทย 6', grade: 'ป.6' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'ภาษาไทย', grade: 'ม.2' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'PLC', grade: null }
              ]
            }
          },
          {
            name: 'ครูอมรเทพ จันทร์ครบ',
            type: 'tutor',
            canTeachGrades: [],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'คณิตศาสตร์', grade: 'ม.1' },
                { period: 3, subject: 'คณิตศาสตร์', grade: 'ม.2' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'คณิตศาสตร์ 6', grade: 'ป.6' },
                { period: 6, subject: null, grade: null }
              ],
              'วันอังคาร': [
                { period: 1, subject: 'คณิตศาสตร์', grade: 'ม.2' },
                { period: 2, subject: 'คณิตศาสตร์', grade: 'ม.1' },
                { period: 3, subject: 'คณิตศาสตร์', grade: 'ม.3' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'คณิตศาสตร์ 6', grade: 'ป.6' },
                { period: 6, subject: null, grade: null }
              ],
              'วันพุธ': [
                { period: 1, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.6' },
                { period: 2, subject: 'คณิตศาสตร์', grade: 'ม.1' },
                { period: 3, subject: 'คณิตศาสตร์', grade: 'ม.3' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'คณิตศาสตร์ 6', grade: 'ป.6' },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: 'คณิตศาสตร์', grade: 'ม.2' },
                { period: 2, subject: 'คณิตศาสตร์', grade: 'ม.3' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: 'คณิตศาสตร์ (เพิ่มเติม)', grade: 'ม.1' },
                { period: 2, subject: 'คณิตศาสตร์ (เพิ่มเติม)', grade: 'ม.2' },
                { period: 3, subject: 'คณิตศาสตร์ (เพิ่มเติม)', grade: 'ม.3' },
                { period: 4, subject: 'วิทยาการคำนวณ', grade: 'ม.3' },
                { period: 5, subject: 'คณิตศาสตร์ 6', grade: 'ป.6' },
                { period: 6, subject: 'แนะแนว', grade: 'ม.3' }
              ]
            }
          },
          {
            name: 'ครูสายรุ้ง เรืองสุขสุด',
            type: 'tutor',
            canTeachGrades: [],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: 'อังกฤษพื้นฐาน', grade: 'ม.2' },
                { period: 2, subject: 'อังกฤษ (เพิ่มเติม)', grade: 'ม.2' },
                { period: 3, subject: 'อังกฤษ (เพิ่มเติม)', grade: 'ม.3' },
                { period: 4, subject: 'อังกฤษพื้นฐาน', grade: 'ม.1' },
                { period: 5, subject: 'อังกฤษเพิ่มเติม 3', grade: 'ป.3' },
                { period: 6, subject: null, grade: null }
              ],
              'วันอังคาร': [
                { period: 1, subject: 'อังกฤษพื้นฐาน', grade: 'ม.1' },
                { period: 2, subject: 'อังกฤษพื้นฐาน 3', grade: 'ป.3' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'อังกฤษพื้นฐาน', grade: 'ม.2' },
                { period: 5, subject: 'วิทยาการคำนวณ', grade: 'ม.1' },
                { period: 6, subject: null, grade: null }
              ],
              'วันพุธ': [
                { period: 1, subject: 'อังกฤษพื้นฐาน', grade: 'ม.3' },
                { period: 2, subject: 'อังกฤษพื้นฐาน', grade: 'ม.2' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'อังกฤษพื้นฐาน 3', grade: 'ป.3' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: 'อังกฤษพื้นฐาน 5', grade: 'ป.5' },
                { period: 2, subject: 'อังกฤษ (เพิ่มเติม)', grade: 'ม.1' },
                { period: 3, subject: 'อังกฤษพื้นฐาน', grade: 'ม.3' },
                { period: 4, subject: 'แนะแนว', grade: 'ม.1' },
                { period: 5, subject: 'อังกฤษพื้นฐาน 3', grade: 'ป.3' },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: 'อังกฤษพื้นฐาน 5', grade: 'ป.5' },
                { period: 2, subject: 'อังกฤษพื้นฐาน 3', grade: 'ป.3' },
                { period: 3, subject: 'อังกฤษพื้นฐาน', grade: 'ม.1' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'อังกฤษพื้นฐาน', grade: 'ม.3' },
                { period: 6, subject: null, grade: null }
              ]
            }
          },
          {
            name: 'ครูอรุณลักษณ์ การกระสัง',
            type: 'tutor',
            canTeachGrades: [],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: 'อังกฤษพื้นฐาน 1', grade: 'ป.1' },
                { period: 2, subject: 'อังกฤษพื้นฐาน 4', grade: 'ป.4' },
                { period: 3, subject: 'อังกฤษเพิ่มเติม 6', grade: 'ป.6' },
                { period: 4, subject: 'อังกฤษพื้นฐาน 2', grade: 'ป.2' },
                { period: 5, subject: 'อังกฤษเพิ่มเติม 5', grade: 'ป.5' },
                { period: 6, subject: null, grade: null }
              ],
              'วันอังคาร': [
                { period: 1, subject: 'อังกฤษพื้นฐาน 2', grade: 'ป.2' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'อังกฤษพื้นฐาน 6', grade: 'ป.6' },
                { period: 4, subject: 'อังกฤษเพิ่มเติม 1', grade: 'ป.1' },
                { period: 5, subject: 'วิทยาการคำนวณ 4', grade: 'ป.4' },
                { period: 6, subject: null, grade: null }
              ],
              'วันพุธ': [
                { period: 1, subject: 'อังกฤษพื้นฐาน 1', grade: 'ป.1' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'อังกฤษพื้นฐาน 6', grade: 'ป.6' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'อังกฤษพื้นฐาน 2', grade: 'ป.2' },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'อังกฤษพื้นฐาน 4', grade: 'ป.4' },
                { period: 3, subject: 'อังกฤษพื้นฐาน 2', grade: 'ป.2' },
                { period: 4, subject: 'อังกฤษพื้นฐาน 1', grade: 'ป.1' },
                { period: 5, subject: 'ซ่อมเสริม', grade: 'ป.4' },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: 'อังกฤษเพิ่มเติม 2', grade: 'ป.2' },
                { period: 2, subject: 'อังกฤษเพิ่มเติม 4', grade: 'ป.4' },
                { period: 3, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.6' },
                { period: 4, subject: 'แนะแนว', grade: 'ป.4' },
                { period: 5, subject: 'อังกฤษพื้นฐาน 1', grade: 'ป.1' },
                { period: 6, subject: 'PLC', grade: null }
              ]
            }
          },

          // --- ครูทั่วไป ---
          {
            name: 'ครูวิภาวัลย์ นันท์มนัส',
            type: 'general',
            canTeachGrades: ['ป.1'],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'คณิตศาสตร์ 1', grade: 'ป.1' },
                { period: 4, subject: 'แนะแนว', grade: 'ป.1' },
                { period: 5, subject: 'ภาษาไทย 1', grade: 'ป.1' },
                { period: 6, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.1' }
              ],
              'วันอังคาร': [
                { period: 1, subject: 'คณิตศาสตร์ 1', grade: 'ป.1' },
                { period: 2, subject: 'วิทยาศาสตร์และเทคฯ 1', grade: 'ป.1' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.1' },
                { period: 6, subject: 'ภาษาไทย 1', grade: 'ป.1' }
              ],
              'วันพุธ': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'คณิตศาสตร์ 1', grade: 'ป.1' },
                { period: 3, subject: 'ภาษาไทย 1', grade: 'ป.1' },
                { period: 4, subject: 'ซ่อมเสริม', grade: 'ป.1' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'ภาษาไทย 1', grade: 'ป.1' },
                { period: 3, subject: 'คณิตศาสตร์ 1', grade: 'ป.1' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'วิทยาการคำนวณ 1', grade: 'ป.1' },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'คณิตศาสตร์ 1', grade: 'ป.1' },
                { period: 3, subject: 'ภาษาไทย 1', grade: 'ป.1' },
                { period: 4, subject: 'ป้องกันการทุจริต 1', grade: 'ป.1' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'PLC', grade: null }
              ]
            }
          },
          {
            name: 'ครูวิภารักษ์ อักโข',
            type: 'general',
            canTeachGrades: ['ป.2'],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: 'คณิตศาสตร์ 2', grade: 'ป.2' },
                { period: 2, subject: 'ภาษาไทย 2', grade: 'ป.2' },
                { period: 3, subject: 'วิทยาศาสตร์และเทคฯ 2', grade: 'ป.2' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'แนะแนว', grade: 'ป.2' },
                { period: 6, subject: 'วิทยาการคำนวณ 2', grade: 'ป.2' }
              ],
              'วันอังคาร': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'คณิตศาสตร์ 2', grade: 'ป.2' },
                { period: 3, subject: 'ภาษาไทย 2', grade: 'ป.2' },
                { period: 4, subject: 'ซ่อมเสริม', grade: 'ป.2' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.2' }
              ],
              'วันพุธ': [
                { period: 1, subject: 'ภาษาไทย 2', grade: 'ป.2' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'คณิตศาสตร์ 2', grade: 'ป.2' },
                { period: 4, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.2' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: 'คณิตศาสตร์ 2', grade: 'ป.2' },
                { period: 2, subject: 'ภาษาไทย 2', grade: 'ป.2' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'คณิตศาสตร์ 2', grade: 'ป.2' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'ป้องกันการทุจริต 2', grade: 'ป.2' },
                { period: 5, subject: 'ภาษาไทย 2', grade: 'ป.2' },
                { period: 6, subject: 'PLC', grade: null }
              ]
            }
          },
          {
            name: 'ครูวิไลพร ดอกแก้ว',
            type: 'general',
            canTeachGrades: ['ป.3'],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: 'แนะแนว', grade: 'ป.3' },
                { period: 2, subject: 'คณิตศาสตร์ 3', grade: 'ป.3' },
                { period: 3, subject: 'ภาษาไทย 3', grade: 'ป.3' },
                { period: 4, subject: 'วิทยาศาสตร์และเทคฯ 3', grade: 'ป.3' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: null, grade: null }
              ],
              'วันอังคาร': [
                { period: 1, subject: 'ภาษาไทย 3', grade: 'ป.3' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'คณิตศาสตร์ 3', grade: 'ป.3' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.3' },
                { period: 6, subject: 'ซ่อมเสริม', grade: 'ป.3' }
              ],
              'วันพุธ': [
                { period: 1, subject: 'คณิตศาสตร์ 3', grade: 'ป.3' },
                { period: 2, subject: 'ภาษาไทย 3', grade: 'ป.3' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'วิทยาการคำนวณ 3', grade: 'ป.3' },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: 'ภาษาไทย 3', grade: 'ป.3' },
                { period: 2, subject: 'คณิตศาสตร์ 3', grade: 'ป.3' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.3' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: 'ภาษาไทย 3', grade: 'ป.3' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'คณิตศาสตร์ 3', grade: 'ป.3' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'ป้องการทุจริต 3', grade: 'ป.3' },
                { period: 6, subject: 'PLC', grade: null }
              ]
            }
          },
          {
            name: 'ครูพจนาจ หวลระลึก',
            type: 'general',
            canTeachGrades: ['ป.4', 'ป.5', 'ป.6'],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'ศิลปะ (ดนตรี) 6', grade: 'ป.6' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ศิลปะ 3', grade: 'ป.3' }
              ],
              'วันอังคาร': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'การงานอาชีพ 1', grade: 'ป.1' },
                { period: 4, subject: 'ประวัติศาสตร์ 3', grade: 'ป.3' },
                { period: 5, subject: 'การงานอาชีพ 2', grade: 'ป.2' },
                { period: 6, subject: 'ศิลปะ (ดนตรี) 5', grade: 'ป.5' }
              ],
              'วันพุธ': [
                { period: 1, subject: 'ศิลปะ (ดนตรี) 4', grade: 'ป.4' },
                { period: 2, subject: 'ศิลปะ (ทัศนศิลป์) 5', grade: 'ป.5' },
                { period: 3, subject: 'สังคมศึกษาฯ 3', grade: 'ป.3' },
                { period: 4, subject: 'ศิลปะ (ทัศนศิลป์) 4', grade: 'ป.4' },
                { period: 5, subject: 'ศิลปะ 1', grade: 'ป.1' },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: 'สุขศึกษาและพลศึกษา 1', grade: 'ป.1' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'สุขศึกษาและพลศึกษา 3', grade: 'ป.3' },
                { period: 4, subject: 'สุขศึกษาและพลศึกษา 2', grade: 'ป.2' },
                { period: 5, subject: 'ศิลปะ 2', grade: 'ป.2' },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: 'สังคมศึกษาฯ 1', grade: 'ป.1' },
                { period: 2, subject: 'ศิลปะ (ทัศนศิลป์) 6', grade: 'ป.6' },
                { period: 3, subject: 'สังคมศึกษาฯ 2', grade: 'ป.2' },
                { period: 4, subject: 'การงานอาชีพ 3', grade: 'ป.3' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'PLC', grade: null }
              ]
            }
          },
          {
            name: 'ครูวิไลวรรณ ทองคำ',
            type: 'general',
            canTeachGrades: ['ป.4', 'ป.5', 'ป.6'],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: 'สังคมศึกษาฯ 5', grade: 'ป.5' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'ภาษาไทย 5', grade: 'ป.5' },
                { period: 4, subject: 'ภาษาไทย 4', grade: 'ป.4' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ประวัติศาสตร์ 6', grade: 'ป.6' }
              ],
              'วันอังคาร': [
                { period: 1, subject: 'ภาษาไทย 5', grade: 'ป.5' },
                { period: 2, subject: 'ประวัติศาสตร์ 4', grade: 'ป.4' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'สังคมศึกษาฯ 6', grade: 'ป.6' },
                { period: 5, subject: 'ป้องกันการทุจริต 5', grade: 'ป.5' },
                { period: 6, subject: 'สังคมศึกษาฯ 4', grade: 'ป.4' }
              ],
              'วันพุธ': [
                { period: 1, subject: 'ภาษาไทย 5', grade: 'ป.5' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'ภาษาไทย 4', grade: 'ป.4' },
                { period: 4, subject: 'สังคมศึกษาฯ 5', grade: 'ป.5' },
                { period: 5, subject: 'ป้องกันการทุจริต 4', grade: 'ป.4' },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'สังคมศึกษาฯ 6', grade: 'ป.6' },
                { period: 3, subject: 'ภาษาไทย 4', grade: 'ป.4' },
                { period: 4, subject: 'วิทยาการคำนวณ 5', grade: 'ป.5' },
                { period: 5, subject: 'ป้องกันการทุจริต 6', grade: 'ป.6' },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: 'สังคมศึกษาฯ 4', grade: 'ป.4' },
                { period: 2, subject: 'ภาษาไทย 5', grade: 'ป.5' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'ประวัติศาสตร์ 5', grade: 'ป.5' },
                { period: 5, subject: 'ภาษาไทย 4', grade: 'ป.4' },
                { period: 6, subject: 'PLC', grade: null }
              ]
            }
          },
          {
            name: 'ครูบรรจง หวังทรัพย์',
            type: 'general',
            canTeachGrades: ['ป.1', 'ป.2', 'ป.4', 'ป.5', 'ป.6', 'ม.1', 'ม.2', 'ม.3'],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'ประวัติศาสตร์ 1', grade: 'ป.1' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'การงานอาชีพ (เพิ่มเติม)', grade: 'ม.3' },
                { period: 5, subject: 'การงานอาชีพ 4', grade: 'ป.4' },
                { period: 6, subject: 'การงานอาชีพ', grade: 'ม.2' }
              ],
              'วันอังคาร': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'การงานอาชีพ 6', grade: 'ป.6' },
                { period: 3, subject: 'การงานอาชีพ', grade: 'ม.2' },
                { period: 4, subject: 'การงานอาชีพ 5', grade: 'ป.5' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'การงานอาชีพ', grade: 'ม.3' }
              ],
              'วันพุธ': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'ประวัติศาสตร์ 2', grade: 'ป.2' },
                { period: 3, subject: 'การงานอาชีพ', grade: 'ม.1' },
                { period: 4, subject: 'การงานอาชีพ', grade: 'ม.3' },
                { period: 5, subject: 'การงานอาชีพ 5', grade: 'ป.5' },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: 'การงานอาชีพ 4', grade: 'ป.4' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'พลศึกษา', grade: 'ม.1' },
                { period: 4, subject: 'พลศึกษา', grade: 'ม.3' },
                { period: 5, subject: 'พลศึกษา', grade: 'ม.2' },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'การงานอาชีพ', grade: 'ม.1' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'การงานอาชีพ 6', grade: 'ป.6' },
                { period: 5, subject: 'การงานอาชีพ (เพิ่มเติม)', grade: 'ม.2' },
                { period: 6, subject: 'การงานอาชีพ (เพิ่มเติม)', grade: 'ม.1' }
              ]
            }
          },
          {
            name: 'ครูเอกพจน์ หัวเขา',
            type: 'general',
            canTeachGrades: ['ม.1', 'ม.2', 'ม.3'],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: 'สังคมศึกษาฯ', grade: 'ม.3' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'สังคมศึกษาฯ', grade: 'ม.1' },
                { period: 6, subject: 'ป้องกันการทุจริต', grade: 'ม.3' }
              ],
              'วันอังคาร': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'สังคมศึกษาฯ', grade: 'ม.3' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'สังคมศึกษาฯ', grade: 'ม.2' }
              ],
              'วันพุธ': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'สังคมศึกษาฯ', grade: 'ม.2' },
                { period: 4, subject: 'ป้องกันการทุจริต', grade: 'ม.2' },
                { period: 5, subject: 'สังคมศึกษาฯ', grade: 'ม.1' },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: 'ประวัติศาสตร์', grade: 'ม.1' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'ประวัติศาสตร์', grade: 'ม.2' },
                { period: 5, subject: 'ประวัติศาสตร์', grade: 'ม.3' },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: 'สังคมศึกษาฯ', grade: 'ม.3' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'สังคมศึกษาฯ', grade: 'ม.2' },
                { period: 4, subject: 'สังคมศึกษาฯ', grade: 'ม.1' },
                { period: 5, subject: 'ป้องกันการทุจริต', grade: 'ม.1' },
                { period: 6, subject: 'แนะแนว', grade: 'ม.2' }
              ]
            }
          },
          {
            name: 'ครูกฤติยา ศรีเพชร',
            type: 'general',
            canTeachGrades: ['ม.1', 'ม.2', 'ม.3'],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: 'คณิตศาสตร์ 4', grade: 'ป.4' },
                { period: 2, subject: 'คณิตศาสตร์ 5', grade: 'ป.5' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.4' }
              ],
              'วันอังคาร': [
                { period: 1, subject: 'สุขศึกษา', grade: 'ม.3' },
                { period: 2, subject: 'คณิตศาสตร์ 5', grade: 'ป.5' },
                { period: 3, subject: 'คณิตศาสตร์ 4', grade: 'ป.4' },
                { period: 4, subject: 'วางทุกงานอ่านทุกคน', grade: 'ป.4' },
                { period: 5, subject: 'วิทยาการคำนวณ', grade: 'ม.2' },
                { period: 6, subject: 'สุขศึกษา', grade: 'ม.1' }
              ],
              'วันพุธ': [
                { period: 1, subject: 'สุขศึกษา', grade: 'ม.2' },
                { period: 2, subject: 'คณิตศาสตร์ 4', grade: 'ป.4' },
                { period: 3, subject: 'คณิตศาสตร์ 5', grade: 'ป.5' },
                { period: 4, subject: 'ซ่อมเสริม', grade: 'ป.6' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: 'คณิตศาสตร์ 5', grade: 'ป.5' },
                { period: 3, subject: 'สุขศึกษาและพลศึกษา 6', grade: 'ป.6' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'คณิตศาสตร์ 4', grade: 'ป.4' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'แนะแนว', grade: 'ป.5' },
                { period: 6, subject: null, grade: null }
              ]
            }
          },
          {
            name: 'ครูคีร่า โอคอนเนล',
            type: 'general',
            canTeachGrades: [], // สอนเฉพาะอังกฤษ
            canTeachSpecial: { subject: 'อังกฤษ', grades: ['ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6', 'ม.1', 'ม.2', 'ม.3'] },
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: 'อังกฤษพื้นฐาน', grade: 'ม.2' },
                { period: 2, subject: 'อังกฤษพื้นฐาน 4', grade: 'ป.4' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'อังกฤษพื้นฐาน 2', grade: 'ป.2' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: null, grade: null }
              ],
              'วันอังคาร': [
                { period: 1, subject: 'อังกฤษพื้นฐาน', grade: 'ม.1' },
                { period: 2, subject: 'อังกฤษพื้นฐาน 3', grade: 'ป.3' },
                { period: 3, subject: 'อังกฤษพื้นฐาน 6', grade: 'ป.6' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: null, grade: null }
              ],
              'วันพุธ': [
                { period: 1, subject: 'อังกฤษพื้นฐาน 1', grade: 'ป.1' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: 'อังกฤษพื้นฐาน 6', grade: 'ป.6' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'อังกฤษพื้นฐาน 2', grade: 'ป.2' },
                { period: 6, subject: 'ลูกเสือ', grade: null }
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: 'อังกฤษพื้นฐาน 5', grade: 'ป.5' },
                { period: 2, subject: 'อังกฤษพื้นฐาน 4', grade: 'ป.4' },
                { period: 3, subject: 'อังกฤษพื้นฐาน', grade: 'ม.3' },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ชุมนุม', grade: null }
              ],
              'วันศุกร์': [
                { period: 1, subject: 'อังกฤษพื้นฐาน 5', grade: 'ป.5' },
                { period: 2, subject: 'อังกฤษพื้นฐาน 3', grade: 'ป.3' },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: 'อังกฤษพื้นฐาน 1', grade: 'ป.1' },
                { period: 6, subject: 'PLC', grade: null }
              ]
            }
          },
		  {
            name: 'รองอัจฉรา มาอินทร์',
            type: 'general', // กำหนด type เป็น general
            // ระบุระดับชั้นที่สอนได้ (ครอบคลุมทุกระดับตามวิชาแนะแนว)
            canTeachGrades: ['ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6', 'ม.1', 'ม.2', 'ม.3'],
            canTeachSpecial: null,
            schedule: {
              'วันจันทร์': [
                { period: 1, subject: 'แนะแนว', grade: 'ป.3' },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'แนะแนว', grade: 'ป.1' },
                { period: 5, subject: 'แนะแนว', grade: 'ป.2' },
                { period: 6, subject: null, grade: null }
              ],
              'วันอังคาร': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'แนะแนว', grade: 'ป.6' }
              ],
              'วันพุธ': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: null, grade: null },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ลูกเสือ', grade: null } // ใส่ ลูกเสือ
              ],
              'วันพฤหัสบดี': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'แนะแนว', grade: 'ม.1' },
                { period: 5, subject: null, grade: null },
                { period: 6, subject: 'ชุมนุม', grade: null } // ใส่ ชุมนุม
              ],
              'วันศุกร์': [
                { period: 1, subject: null, grade: null },
                { period: 2, subject: null, grade: null },
                { period: 3, subject: null, grade: null },
                { period: 4, subject: 'แนะแนว', grade: 'ป.4' },
                { period: 5, subject: 'แนะแนว', grade: 'ป.5' },
                // รวม ม.2 และ ม.3 - ใช้แค่ ม.2 หรือ ม.3 ก็ได้ เพราะไม่มีผลกับการคำนวณคาบว่าง
                { period: 6, subject: 'แนะแนว', grade: 'ม.2' }
              ]
            }
          }
        ];

        // --- HELPER FUNCTIONS ---

        const EXCLUDED_SUBJECTS = ['ลูกเสือ', 'ชุมนุม', 'PLC'];
        const TUTORING_GRADES = ['ป.6', 'ม.3'];
        const PERIOD_TIMES = { // Define period start/end times if needed for display
            1: "08:30 - 09:30", 2: "09:30 - 10:30", 3: "10:30 - 11:30",
            4: "12:30 - 13:30", 5: "13:30 - 14:30", 6: "14:30 - 15:30"
            // Adjust these times as per actual school schedule if different from O-NET blocks
        };

        function formatDateToKey(dateString) {
          if (!dateString) return null;
          const [year, month, day] = dateString.split('-');
          const buddhistYear = parseInt(year) + 543;
          return `${day}/${month}/${buddhistYear}`;
        }
		
		function dateKeyToDate(dateKey) {
    if (!dateKey) return null;
    const [day, month, year] = dateKey.split('/');
    const gregorianYear = parseInt(year) - 543;
    // month - 1 เพราะ JavaScript นับเดือนจาก 0-11
    return new Date(gregorianYear, parseInt(month) - 1, parseInt(day));
}

        function getDayOfWeek(dateKey) {
          if (!dateKey) return null;
          const [day, month, year] = dateKey.split('/');
          const gregorianYear = parseInt(year) - 543;
          const date = new Date(`${gregorianYear}-${month}-${day}`);
          const dayIndex = date.getDay();
          const days = ['วันอาทิตย์', 'วันจันทร์', 'วันอังคาร', 'วันพุธ', 'วันพฤหัสบดี', 'วันศุกร์', 'วันเสาร์'];
          return days[dayIndex];
        }

        function canTeacherSubstitute(teacher, targetGrade, targetSubject) {
            if (!targetGrade) return true;
            if (!targetSubject) return false; // Added check for null subject

            // Handle special subject teacher (e.g., English only)
            if (teacher.canTeachSpecial) {
                const { subject, grades } = teacher.canTeachSpecial;
                if (targetSubject.toLowerCase().includes(subject.toLowerCase())) {
                    if (grades.includes(targetGrade)) {
                        return true;
                    }
                }
            }

            // Handle general grade teacher
            if (teacher.canTeachGrades.includes(targetGrade)) {
                return true;
            }

            return false;
        }


        function isGradeTutoring(grade, period, onetDaySchedule) {
          if (!TUTORING_GRADES.includes(grade) || !onetDaySchedule) {
            return false;
          }
          for (const session of onetDaySchedule) {
            if (session.grade === grade && session.periods.includes(period)) {
              return true;
            }
          }
          return false;
        }

        function isTeacherTutoring(teacherName, period, onetDaySchedule) {
            if (!onetDaySchedule) {
                return false;
            }
            for (const session of onetDaySchedule) {
                if (session.teacher === teacherName && session.periods.includes(period)) {
                    return true;
                }
            }
            return false;
        }

function parseGradeToNumber(grade) {
            if (!grade || typeof grade !== 'string') return 0;
            const num = parseInt(grade.replace(/\D/g, ''));
            if (isNaN(num)) return 0;
            if (grade.startsWith('ม')) return num + 6; // ป.6 = 6, ม.1 = 7
            return num; // ป.1 = 1, ป.5 = 5
        }

        function getGradeProximity(teacherGrades, targetGrade) {
            const targetNum = parseGradeToNumber(targetGrade);
            if (targetNum === 0) return 99; // Cannot compare
            if (!teacherGrades || teacherGrades.length === 0) return 99; // Teacher has no specified grades

            let minDiff = Infinity;
            for (const g of teacherGrades) {
                const diff = Math.abs(parseGradeToNumber(g) - targetNum);
                if (diff < minDiff) {
                    minDiff = diff;
                }
            }
            return minDiff;
        }
		
		function isTeacherP1toP3Only(teacher) {
            // ถ้าครูไม่มี canTeachGrades (เช่น ครูสอนภาษา) ให้ถือว่าไม่ใช
            if (!teacher.canTeachGrades || teacher.canTeachGrades.length === 0) {
                return false; 
            }
            
            // ตรวจสอบว่า "ทุกระดับชั้น" ที่ครูสอนได้ อยู่ในช่วง ป.1 - ป.3 หรือไม่
            return teacher.canTeachGrades.every(grade => {
                const gradeNum = parseGradeToNumber(grade); // ป.1=1, ป.2=2, ป.3=3
                return gradeNum >= 1 && gradeNum <= 3;
            });
        }

function generateSchedules(dateKey) {
    const onetDaySchedule = onetData[dateKey]; //
    const dayOfWeek = getDayOfWeek(dateKey); //

    const initialResult = {
        teacherSchedule: [],
        studentScheduleByGrade: {},
        fullDateText: '',
        dayOfWeekText: dayOfWeek || ''
    };

    if (!onetDaySchedule || !dayOfWeek) {
        return initialResult; // No O-NET on this day or invalid day
    }

    const [day, monthIndex, year] = dateKey.split('/');
    const thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
    initialResult.fullDateText = `วันที่ ${parseInt(day)} ${thaiMonths[parseInt(monthIndex) - 1]} ${year}`;
    initialResult.dayOfWeekText = dayOfWeek;

    // 1. Initialize teacher workloads and track original schedule
    const teacherWorkloads = {};
    const finalPeriodAssignments = {}; // { 1: { 'ป.1': { subject, teacher, originalTeacher, subChoiceReason? }, ... }, ... }

    allTeacherData.forEach(teacher => { //
        let baseWorkload = 0;
        const normalSchedule = teacher.schedule[dayOfWeek];
        if (normalSchedule) {
            normalSchedule.forEach(cls => {
                // Track original assignment
                if (!finalPeriodAssignments[cls.period]) finalPeriodAssignments[cls.period] = {};
                if (cls.grade && cls.subject && !EXCLUDED_SUBJECTS.includes(cls.subject)) { //
                    finalPeriodAssignments[cls.period][cls.grade] = {
                        subject: cls.subject,
                        teacher: teacher.name, // Initially set to the original teacher
                        originalTeacher: teacher.name
                        // subChoiceReason will be added later if needed
                    };
                }

                // Calculate initial workload (excluding classes during own O-NET or where students are away)
                if (cls.subject && !EXCLUDED_SUBJECTS.includes(cls.subject)) { //
                    if (!isGradeTutoring(cls.grade, cls.period, onetDaySchedule) && !isTeacherTutoring(teacher.name, cls.period, onetDaySchedule)) { //
                        baseWorkload++;
                    }
                }
            });
        }
        teacherWorkloads[teacher.name] = { base: baseWorkload, onet: 0, sub: 0, total: baseWorkload };
    });

    // 2. Add O-NET tutoring workload
    onetDaySchedule.forEach(session => {
        const tutorName = session.teacher;
        if (teacherWorkloads[tutorName]) {
            const onetHours = session.periods.length;
            teacherWorkloads[tutorName].onet = onetHours;
            teacherWorkloads[tutorName].total += onetHours;
        }
    });

    // 3. Find and assign substitutes
    const teacherSubSchedule = []; // For the teacher tab display
    const substitutionsMade = {}; // Tracks { period: [assignedSubName, ...], ... }

    for (const session of onetDaySchedule) {
        const tutorName = session.teacher; // The teacher who is busy tutoring (e.g., ครูอรุณลักษณ์)
        const tutor = allTeacherData.find(t => t.name === tutorName); //
        const onetPeriods = session.periods;

        if (!tutor) continue;

        const scheduleEntry = {
            tutorName: tutor.name,
            reason: `ติดติว O-NET ${session.subject} ${session.grade} เวลา ${session.time}`, // Reason for the original teacher's absence
            substitutions: [] // List of classes needing subs for this tutor
        };

        const tutorNormalSchedule = tutor.schedule[dayOfWeek];

        for (const classToCover of tutorNormalSchedule) {
            const period = classToCover.period;
            const grade = classToCover.grade;
            const subject = classToCover.subject;

            // Skip if: not during O-NET, no subject, excluded subject, or the students are also at O-NET
            if (!onetPeriods.includes(period) || !subject || EXCLUDED_SUBJECTS.includes(subject) || isGradeTutoring(grade, period, onetDaySchedule)) { //
                // Note: We don't remove from finalPeriodAssignments here, just skip finding a sub
                continue;
            }

            // --- Find Substitute (Revised Logic) ---
            let qualifiedCandidates = [];
            let fallbackCandidates = [];

            for (const potentialSub of allTeacherData) { //
                if (potentialSub.name === tutorName) continue; // Cannot sub self

                // Skip รองอัจฉรา during normal search (she only subs via override)
                if (potentialSub.name === 'รองอัจฉรา มาอินทร์') { //
                    continue;
                }

                // Check 1: Is teacher busy with O-NET or already subbing this period?
                if (isTeacherTutoring(potentialSub.name, period, onetDaySchedule) || (substitutionsMade[period] && substitutionsMade[period].includes(potentialSub.name))) { //
                    continue; // Teacher busy
                }

                // Check 2: Is teacher's normal schedule vacant?
                const subScheduleSlot = potentialSub.schedule[dayOfWeek]?.find(s => s.period === period);
                let isVacant = (!subScheduleSlot || !subScheduleSlot.subject || EXCLUDED_SUBJECTS.includes(subScheduleSlot.subject)) //
                               || isGradeTutoring(subScheduleSlot?.grade, period, onetDaySchedule); //

                if (isVacant) {
                    const workload = teacherWorkloads[potentialSub.name].total;

                    // Check 3: Are they qualified?
                    if (canTeacherSubstitute(potentialSub, grade, subject)) { //
                        qualifiedCandidates.push({
                            name: potentialSub.name,
                            currentWorkload: workload
                        });
                    } else {
                        // Check P.1-P.3 rule before adding to fallback
                        const targetGradeNum = parseGradeToNumber(grade); //
                        const isP1toP3Teacher = isTeacherP1toP3Only(potentialSub); //

                        if (!(isP1toP3Teacher && targetGradeNum > 3)) {
                            const proximity = getGradeProximity(potentialSub.canTeachGrades, grade); //
                            fallbackCandidates.push({
                                name: potentialSub.name,
                                currentWorkload: workload,
                                proximity: proximity
                            });
                        }
                    }
                }
            } // End loop through potential subs

            // --- Assign Substitute (Revised Logic) ---
            let bestSubName = null;
            let reason = ''; // Reason why this sub was chosen
            let newWorkload = 0;

            if (qualifiedCandidates.length > 0) {
                qualifiedCandidates.sort((a, b) => a.currentWorkload - b.currentWorkload);
                bestSubName = qualifiedCandidates[0].name;
                newWorkload = qualifiedCandidates[0].currentWorkload + 1;
                reason = `ครูว่าง (คาบรวมน้อยสุด), คาบรวม=${newWorkload}`;
            } else if (fallbackCandidates.length > 0) {
                fallbackCandidates.sort((a, b) => {
                    if (a.proximity !== b.proximity) return a.proximity - b.proximity;
                    return a.currentWorkload - b.currentWorkload;
                });
                bestSubName = fallbackCandidates[0].name;
                newWorkload = fallbackCandidates[0].currentWorkload + 1;
                reason = `มอบหมายครู (ใกล้เคียงสุด/คาบรวมน้อยสุด), คาบรวม=${newWorkload}`;
            } else {
                reason = 'หาคนสอนแทนไม่ได้ (ทุกครูติดสอน/ติว)';
            }

            // --- !!! Override Condition !!! ---
            if (bestSubName === 'ครูวิภาวัลย์ นันท์มนัส') { //
                const rorAcharraName = 'รองอัจฉรา มาอินทร์'; //
                console.log(`Override: Changing sub from ครูวิภาวัลย์ to ${rorAcharraName} for period ${period}, class ${grade}/${subject}`);
                bestSubName = rorAcharraName;
                reason = `มอบหมายพิเศษ`; // Update reason for clarity
                // Recalculate newWorkload for รองอัจฉรา (optional, but good practice)
                if (teacherWorkloads[rorAcharraName]) {
                    newWorkload = teacherWorkloads[rorAcharraName].total + 1;
                    // We don't update the displayed reason string with the new workload here,
                    // but the actual workload calculation below will use the correct teacher.
                }
            }
            // --- !!! End Override Condition !!! ---

            // --- Record the assignment (or failure) for the teacher tab display ---
            scheduleEntry.substitutions.push({
                period: period,
                classInfo: `${grade || 'ไม่ระบุ'}/${subject}`,
                subTeacher: bestSubName,
                reason: reason // This is the reason why bestSubName was chosen (or override reason)
            });

            // --- Update workloads and final assignments IF a sub was found ---
            if (bestSubName) {
                // Update workload for the assigned sub
                if(teacherWorkloads[bestSubName]){ // Check if teacher exists in workloads
                   teacherWorkloads[bestSubName].sub++;
                   teacherWorkloads[bestSubName].total++;
                } else {
                    console.error(`Teacher ${bestSubName} not found in workloads.`);
                }


                // Track that this sub is busy this period
                if (!substitutionsMade[period]) substitutionsMade[period] = [];
                substitutionsMade[period].push(bestSubName);

                // --- !!! Update the final assignment, including the reason !!! ---
                if (grade && finalPeriodAssignments[period]?.[grade]) {
                     // Check if the original teacher matches the one causing the substitution need
                    if (finalPeriodAssignments[period][grade].originalTeacher === tutorName) {
                        finalPeriodAssignments[period][grade].teacher = bestSubName; // Update teacher
                        finalPeriodAssignments[period][grade].subChoiceReason = reason; // <-- STORE THE REASON
                    } else {
                         // This case might happen if the data conflict caused the original teacher to be wrong
                         // We still assign the sub, but log a warning.
                         console.warn(`Assigning substitute ${bestSubName} for period ${period}, grade ${grade}, but original teacher in finalAssignments (${finalPeriodAssignments[period][grade].originalTeacher}) doesn't match tutorName (${tutorName}). Overwriting anyway.`);
                         finalPeriodAssignments[period][grade].teacher = bestSubName;
                         finalPeriodAssignments[period][grade].subChoiceReason = reason; // <-- STORE THE REASON
                    }
                } else if (grade) {
                    // This case should ideally not happen if initial population was correct, but handle defensively
                     console.warn(`finalPeriodAssignments entry missing for period ${period}, grade ${grade}. Creating new entry.`);
                     if(!finalPeriodAssignments[period]) finalPeriodAssignments[period] = {};
                     finalPeriodAssignments[period][grade] = {
                         subject: subject,
                         teacher: bestSubName,
                         originalTeacher: tutorName, // Assume original was the tutor causing the need
                         subChoiceReason: reason // <-- STORE THE REASON
                     };
                }
                // --- !!! End updating final assignment !!! ---

            } else {
                 // No sub found, mark teacher as null in final assignments if it was the tutor's class
                if (grade && finalPeriodAssignments[period]?.[grade]?.originalTeacher === tutorName) {
                   finalPeriodAssignments[period][grade].teacher = null; // Mark teacher as null
                   // Optionally add a reason like 'No Substitute Found'
                   // finalPeriodAssignments[period][grade].subChoiceReason = 'หาคนสอนแทนไม่ได้';
                }
            }
        } // End loop through tutor's classes needing cover

        if (scheduleEntry.substitutions.length > 0) {
            teacherSubSchedule.push(scheduleEntry);
        }
    } // End loop through O-NET sessions (tutors needing cover)

    // 4. Build Student Schedule from finalPeriodAssignments
    const studentScheduleByGrade = {};
    const allGrades = ['ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6', 'ม.1', 'ม.2', 'ม.3'];

    allGrades.forEach(grade => {
        studentScheduleByGrade[grade] = [];
         for (let period = 1; period <= 6; period++) {
             const assignment = finalPeriodAssignments[period]?.[grade];
             if (assignment) {
                const isSubstitute = assignment.teacher !== assignment.originalTeacher && assignment.teacher !== null;
                 studentScheduleByGrade[grade].push({
                     period: period,
                     subject: assignment.subject,
                     teacher: assignment.teacher,
                     isSubstitute: isSubstitute
                     // We don't need originalTeacher or subChoiceReason in student view
                 });
             }
         }
         studentScheduleByGrade[grade].sort((a, b) => a.period - b.period);
    });

    // Return all necessary data
    return {
        teacherSchedule: teacherSubSchedule, // For "ตารางสอนแทน (สำหรับครู)" tab
        studentScheduleByGrade,           // For "ตารางเรียน (สำหรับนักเรียน)" tab
        fullDateText: initialResult.fullDateText, // For headers
        dayOfWeekText: initialResult.dayOfWeekText, // For headers
        finalPeriodAssignments: finalPeriodAssignments,
		teacherWorkloads: teacherWorkloads
    };
} // --- End of generateSchedules function ---
		
		// --- CORE WORKLOAD SUMMARY LOGIC ---

// --- CORE WORKLOAD SUMMARY LOGIC (แก้ไขล่าสุด) ---

function calculateWorkloadSummary(startDateKey, endDateKey) {
    const summary = {};
    const startDate = dateKeyToDate(startDateKey); //
    const endDate = dateKeyToDate(endDateKey); //

    // 1. Initialize summary object for all teachers
    allTeacherData.forEach(teacher => {
        summary[teacher.name] = {
            name: teacher.name,
            type: teacher.type, //
            normal: 0,
            sub: 0,
            onet: 0,
            total: 0
        };
    });

    // 2. Iterate through all dates in onetData
    for (const dateKey in onetData) {
        const currentDate = dateKeyToDate(dateKey); //

        // Check if the date is within the specified range
        if (currentDate >= startDate && currentDate <= endDate) {
            const dayOfWeek = getDayOfWeek(dateKey); //
            const onetDaySchedule = onetData[dateKey]; //

            if (!dayOfWeek || !onetDaySchedule) continue; // Skip if no schedule or invalid day

            // 3. Calculate O-NET hours
            onetDaySchedule.forEach(session => {
                if (summary[session.teacher]) {
                    summary[session.teacher].onet += session.periods.length;
                }
            });

            // 4. Calculate Substitute hours (by running the daily schedule generator)
            // and build lookup for substitute check
            const dailySchedules = generateSchedules(dateKey); //

            // --- สร้าง Lookup สำหรับตรวจสอบว่าใครสอนแทนคาบไหนในวันนี้ ---
            const subsLookup = {}; // Format: { 1: ["TeacherA"], 2: ["TeacherB", "TeacherC"], ... }
            dailySchedules.teacherSchedule.forEach(tutorEntry => {
                tutorEntry.substitutions.forEach(sub => {
                    if (sub.subTeacher) {
                        if (!subsLookup[sub.period]) {
                            subsLookup[sub.period] = [];
                        }
                        subsLookup[sub.period].push(sub.subTeacher);

                        // นับชั่วโมงสอนแทนใน summary object ด้วย
                        if (summary[sub.subTeacher]) {
                             summary[sub.subTeacher].sub += 1;
                        }
                    }
                });
            });
            // --- จบส่วนสร้าง Lookup ---

            // 5. Calculate Normal hours (excluding P.6, M.3, own tutoring, and substitute teaching)
            allTeacherData.forEach(teacher => {
                const teacherName = teacher.name;
                const normalSchedule = teacher.schedule[dayOfWeek];
                if (!normalSchedule) return; // Corrected from continue

                for (let period = 1; period <= 6; period++) {
                    const cls = normalSchedule.find(s => s.period === period);

                    if (!cls || !cls.subject || !cls.grade || EXCLUDED_SUBJECTS.includes(cls.subject)) { //
                        continue; // Skip if no class, no subject, or excluded subject
                    }

                    // --- APPLY EXCLUSION RULES ---

                    // Rule 1: Exclude if teacher is tutoring O-NET at this time
                    if (isTeacherTutoring(teacherName, period, onetDaySchedule)) { //
                        continue;
                    }

                    // Rule 2: Exclude if the class is P.6 or M.3 (students are at O-NET)
                    if (cls.grade === 'ป.6' || cls.grade === 'ม.3') { //
                        continue;
                    }

                    // --- !!! กฎใหม่: Exclude if teacher is substituting at this time !!! ---
                    if (subsLookup[period] && subsLookup[period].includes(teacherName)) {
                        continue; // ข้ามการนับชั่วโมงปกติ เพราะกำลังสอนแทนอยู่
                    }
                    // --- !!! จบกฎใหม่ !!! ---

                    // If all checks pass, it's a valid normal teaching hour
                    summary[teacherName].normal += 1;
                }
            }); // End allTeacherData.forEach
        } // End date range check
    } // End loop through onetData

    // 6. Calculate totals (ย้ายการคำนวณ .sub ออกไปแล้ว)
    const summaryArray = Object.values(summary).map(teacher => {
        teacher.total = teacher.normal + teacher.sub + teacher.onet;
        return teacher;
    });

    // 7. Sort the array: Tutors first, then by total hours
    summaryArray.sort((a, b) => {
        if (a.type === 'tutor' && b.type !== 'tutor') return -1; //
        if (a.type !== 'tutor' && b.type === 'tutor') return 1; //
        return b.total - a.total; // Sort by total descending
    });

    return summaryArray;
}


        // --- UI Rendering ---
        const datePicker = document.getElementById('date-picker');
        // Tab elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const teacherScheduleContent = document.getElementById('teacher-schedule-content');
        const studentScheduleContent = document.getElementById('student-schedule-content');
        const teacherScheduleDetails = document.getElementById('teacher-schedule-details');
        const studentScheduleDetails = document.getElementById('student-schedule-details');
        const teacherHeaderEl = document.getElementById('teacher-schedule-header');
        const studentHeaderEl = document.getElementById('student-schedule-header');
        const teacherNoDataEl = document.getElementById('teacher-schedule-nodata');
        const studentNoDataEl = document.getElementById('student-schedule-nodata');
		const summaryContent = document.getElementById('summary-content');
const summaryHeaderEl = document.getElementById('summary-schedule-header');
const summaryScheduleDetails = document.getElementById('summary-schedule-details');
const summaryNoDataEl = document.getElementById('summary-schedule-nodata');
const onetOverviewHeaderEl = document.getElementById('onet-overview-header');
const onetOverviewDetails = document.getElementById('onet-overview-details');
const onetOverviewNoDataEl = document.getElementById('onet-overview-nodata');
const prevRotationBtn = document.getElementById('prev-rotation-btn');
const nextRotationBtn = document.getElementById('next-rotation-btn');
const rotationStatus = document.getElementById('rotation-status');
const exportCombinedBtn = document.getElementById('export-combined-btn');
const shareCombinedBtn = document.getElementById('share-combined-btn');
// ตัวแปรใหม่ที่เราเพิ่ม
const substituteSummaryScheduleHeaderEl = document.getElementById('substitute-summary-schedule-header');
const substituteSummaryScheduleDetails = document.getElementById('substitute-summary-schedule-details');
const substituteSummaryScheduleNoDataEl = document.getElementById('substitute-summary-schedule-nodata');
// จบตัวแปรใหม่
        // Action buttons & Toast
        const exportBtn = document.getElementById('export-btn');
        const shareBtn = document.getElementById('share-btn');
        const toast = document.getElementById('toast');
        let toastTimeout;
        let currentFullSchedule = null; // Store the generated schedule
		let workloadSummaryData = null; // เพิ่มตัวแปรนี้
		let onetOverviewTableHTML = null; // Cache for the overview table

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Function to render the TEACHER substitution details
        function renderTeacherSchedule(scheduleData) {
             teacherScheduleDetails.innerHTML = '';
             teacherNoDataEl.classList.add('hidden');
             teacherHeaderEl.innerHTML = `📆 ผลการจัดตารางสอนแทน ${scheduleData.dayOfWeekText} ${scheduleData.fullDateText}`;


            if (scheduleData.teacherSchedule.length > 0) {
                scheduleData.teacherSchedule.forEach(tutorEntry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = "bg-slate-50 p-5 rounded-lg shadow-md border border-slate-200";
                    const tutorHeader = document.createElement('h4');
                    tutorHeader.className = "text-xl font-semibold text-indigo-900 mb-4";
                    tutorHeader.innerHTML = `สอนแทน ${tutorEntry.tutorName} <span class="font-normal text-slate-700 text-base block md:inline md:ml-2">(${tutorEntry.reason})</span>`;
                    entryDiv.appendChild(tutorHeader);
                    const subList = document.createElement('ul');
                    subList.className = "list-disc list-inside space-y-3 pl-2";
                    tutorEntry.substitutions.forEach(sub => {
                        const listItem = document.createElement('li');
                        listItem.className = "text-slate-800 text-base md:text-lg";
                        let subTeacherHtml = sub.subTeacher ? `<strong class="text-green-700 ml-1">${sub.subTeacher}</strong>` : `<strong class="text-red-600 ml-1">หาคนสอนแทนไม่ได้</strong>`;
                        listItem.innerHTML = `<strong class="text-slate-900">คาบ ${sub.period}:</strong> ${sub.classInfo} → ${subTeacherHtml} <span class="text-sm text-slate-500 block md:inline md:ml-2">(${sub.reason})</span>`;
                        subList.appendChild(listItem);
                    });
                    entryDiv.appendChild(subList);
                    teacherScheduleDetails.appendChild(entryDiv);
                });
            } else {
                 teacherNoDataEl.textContent = scheduleData.dayOfWeekText ? `ไม่มีการติว O-NET หรือไม่มีคาบสอนแทนในวันนี้` : "กรุณาเลือกวันที่ที่ถูกต้อง";
                 teacherNoDataEl.classList.remove('hidden');
            }
        }

        // *** UPDATED Function to render the STUDENT schedule (Filtered) ***
        function renderStudentSchedule(scheduleData) {
             studentScheduleDetails.innerHTML = ''; // Clear previous student schedule
             studentNoDataEl.classList.add('hidden');
             studentHeaderEl.innerHTML = `🧑‍🎓 ตารางเรียน ${scheduleData.dayOfWeekText} ${scheduleData.fullDateText} (เฉพาะคาบที่มีการสอนแทน)`; // Updated Header

             const grades = Object.keys(scheduleData.studentScheduleByGrade).sort(); // Sort grades P.1, P.2... M.1...
             let hasAnySubstitution = false; // Flag to check if any grade has subs

             grades.forEach(grade => {
                 const fullGradeSchedule = scheduleData.studentScheduleByGrade[grade];
                 // Filter for substitute classes ONLY for this grade
                 const substituteClasses = fullGradeSchedule.filter(cls => cls.isSubstitute);

                 // Only proceed if this grade has substitute classes
                 if (substituteClasses.length > 0) {
                     hasAnySubstitution = true; // Mark that we found at least one sub

                     const gradeDiv = document.createElement('div');
                     gradeDiv.className = "bg-blue-50 p-5 rounded-lg shadow-md border border-blue-200 mb-4"; // Different color for student view

                     const gradeHeader = document.createElement('h4');
                     gradeHeader.className = "text-xl font-semibold text-blue-900 mb-3";
                     gradeHeader.textContent = `ระดับชั้น ${grade}`;
                     gradeDiv.appendChild(gradeHeader);

                     const classList = document.createElement('ul');
                     classList.className = "list-none space-y-2"; // Use list-none for cleaner look

                     // Iterate ONLY through the filtered substitute classes
                     substituteClasses.forEach(cls => {
                         const listItem = document.createElement('li');
                         listItem.className = "text-slate-800 text-base md:text-lg border-b border-blue-100 pb-1";

                         // Teacher name will always be substitute here
                         const teacherNameHtml = `<strong class="text-orange-600">${cls.teacher} (สอนแทน)</strong>`;

                         listItem.innerHTML = `
                             <strong class="text-blue-800 w-16 inline-block">คาบ ${cls.period}:</strong>
                             <span class="font-medium mr-2">${cls.subject}</span>
                             → ${teacherNameHtml}
                         `;
                         classList.appendChild(listItem);
                     });

                     gradeDiv.appendChild(classList);
                     studentScheduleDetails.appendChild(gradeDiv);
                 } // End if (substituteClasses.length > 0)
             }); // End forEach grade

             // Show no data message ONLY if NO grades had any substitutions
             if (!hasAnySubstitution) {
                  studentNoDataEl.textContent = scheduleData.dayOfWeekText ? `ไม่มีคาบเรียนที่มีการสอนแทนในวันนี้` : "กรุณาเลือกวันที่ที่ถูกต้อง"; // Updated no data text
                  studentNoDataEl.classList.remove('hidden');
             }
        }
				
// *** Function to render the Workload Summary table ***
function renderWorkloadSummary(summaryData) {
    summaryScheduleDetails.innerHTML = ''; // Clear previous table
    summaryNoDataEl.classList.add('hidden');
    summaryHeaderEl.textContent = `สรุปชั่วโมงสอนช่วงติว O-NET (10/11/2568 - 30/01/2569)`;

    if (!summaryData || summaryData.length === 0) {
        summaryNoDataEl.textContent = 'ไม่สามารถคำนวณข้อมูลสรุปได้';
        summaryNoDataEl.classList.remove('hidden');
        return;
    }

    // Create table structure
    const table = document.createElement('table');
    table.className = "min-w-full divide-y divide-slate-200 border border-slate-300 shadow-md rounded-lg";

    // Create Table Header
    const thead = document.createElement('thead');
    thead.className = "bg-slate-100";
    thead.innerHTML = `
        <tr>
            <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">ลำดับ</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ชื่อ-สกุล</th>
            <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">สอนปกติ</th>
            <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">สอนแทน</th>
            <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">ติว O-NET</th>
            <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">รวม (ชั่วโมง)</th>
        </tr>
    `;
    table.appendChild(thead);

    // Create Table Body
    const tbody = document.createElement('tbody');
    tbody.className = "bg-white divide-y divide-slate-200";

    summaryData.forEach((teacher, index) => {
        const tr = document.createElement('tr');

        // Apply highlight for tutors
        if (teacher.type === 'tutor') {
            tr.className = "bg-indigo-50 hover:bg-indigo-100";
        } else {
             tr.className = "hover:bg-slate-50";
        }

        tr.innerHTML = `
            <td class="px-4 py-3 whitespace-nowrap text-center text-sm text-slate-500">${index + 1}</td>
            <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${teacher.type === 'tutor' ? '✅ ' : ''}${teacher.name}</td>
            <td class="px-4 py-3 whitespace-nowrap text-center text-sm text-slate-700">${teacher.normal}</td>
            <td class="px-4 py-3 whitespace-nowrap text-center text-sm text-slate-700">${teacher.sub}</td>
            <td class="px-4 py-3 whitespace-nowrap text-center text-sm text-slate-700">${teacher.onet}</td>
            <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-bold text-indigo-800">${teacher.total}</td>
        `;
        tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    summaryScheduleDetails.appendChild(table);
}

// *** Function to render the O-NET Overview Table (แก้ไข) ***
function renderOnetOverviewTable(selectedDateKey) { // <-- 1. รับ selectedDateKey
    onetOverviewDetails.innerHTML = '';
    onetOverviewNoDataEl.classList.add('hidden');
    onetOverviewHeaderEl.textContent = 'ภาพรวมตารางติว O-NET (10/11/2568 - 30/01/2569)';

    // --- 2. ลบการใช้ Cache (if block) ออกไป ---
    
    // ... (โค้ดสร้าง const table, thead, tbody ไม่เปลี่ยนแปลง) ...
    const table = document.createElement('table');
    table.className = "min-w-full divide-y divide-slate-200 border border-slate-300 shadow-md rounded-lg";
    table.innerHTML = `
        <thead class="bg-indigo-100">
            <tr>
                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-indigo-800 uppercase tracking-wider">วันที่</th>
                <th scope="col" class="px-2 py-3 text-center text-xs font-semibold text-indigo-800 uppercase tracking-wider">วัน</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-indigo-800 uppercase tracking-wider">ป.6 (08:00 - 11:30)</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-indigo-800 uppercase tracking-wider">ป.6 (12:30 - 16:00)</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-indigo-800 uppercase tracking-wider">ม.3 (08:00 - 11:30)</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-indigo-800 uppercase tracking-wider">ม.3 (12:30 - 16:00)</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-slate-200">
        </tbody>
    `;
    const tbody = table.querySelector('tbody');

    const allDates = Object.keys(onetData).sort((a, b) => dateKeyToDate(a) - dateKeyToDate(b));

    if (allDates.length === 0) {
        onetOverviewNoDataEl.textContent = 'ไม่พบข้อมูลตารางติวในระบบ';
        onetOverviewNoDataEl.classList.remove('hidden');
        return;
    }

    allDates.forEach(dateKey => {
        const dayOfWeek = getDayOfWeek(dateKey).replace('วัน', ''); 
        const sessions = onetData[dateKey]; 

        const p6_m = sessions.find(s => s.grade === 'ป.6' && s.periods[0] < 4);
        const p6_a = sessions.find(s => s.grade === 'ป.6' && s.periods[0] >= 4);
        const m3_m = sessions.find(s => s.grade === 'ม.3' && s.periods[0] < 4);
        const m3_a = sessions.find(s => s.grade === 'ม.3' && s.periods[0] >= 4);

        const formatCell = (session) => {
            if (!session) return '<span class="text-slate-400">—</span>';
            return `<span class="text-sm font-medium">${session.subject}</span><br><span class="text-xs text-slate-600">(${session.teacher})</span>`;
        };

        // --- 3. เพิ่มการตรวจสอบไฮไลต์ ---
        const isSelected = (dateKey === selectedDateKey);
        const tr = document.createElement('tr');
        // ใช้ bg-yellow-100 สำหรับแถวที่ถูกเลือก
        tr.className = isSelected ? "bg-yellow-100 hover:bg-yellow-200" : "hover:bg-slate-50";
        // --- จบส่วนที่ 3 ---

        tr.innerHTML = `
            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700">${dateKey}</td>
            <td class="px-2 py-3 whitespace-nowrap text-center text-sm text-slate-700">${dayOfWeek}</td>
            <td class="px-4 py-3 whitespace-nowrap">${formatCell(p6_m)}</td>
            <td class="px-4 py-3 whitespace-nowrap">${formatCell(p6_a)}</td>
            <td class="px-4 py-3 whitespace-nowrap">${formatCell(m3_m)}</td>
            <td class="px-4 py-3 whitespace-nowrap">${formatCell(m3_a)}</td>
        `;
        tbody.appendChild(tr);
    });

    // อัปเดต Cache ใหม่ทุกครั้ง (เพื่อให้ Export/Share ยังทำงานได้)
    onetOverviewTableHTML = table.outerHTML;
    onetOverviewDetails.appendChild(table);
}
// *** Function to render the Substitution Summary Schedule (แก้ไข V3 - แสดงคาบรวมสุดท้าย) ***
function renderSubstitutionSchedule(scheduleData) {
    substituteSummaryScheduleDetails.innerHTML = '';
    substituteSummaryScheduleNoDataEl.classList.add('hidden');
    substituteSummaryScheduleHeaderEl.innerHTML = `📝 สรุปการสอนแทน ${scheduleData.dayOfWeekText} ${scheduleData.fullDateText}`;

    // 1. ดึงข้อมูลตารางสอนสุดท้าย
    const finalAssignments = scheduleData.finalPeriodAssignments; //

    // --- ตรวจสอบ finalAssignments ก่อน ---
    if (!finalAssignments) {
        substituteSummaryScheduleNoDataEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบข้อมูลตารางสอน';
        substituteSummaryScheduleNoDataEl.classList.remove('hidden');
        console.error("renderSubstitutionSchedule: finalPeriodAssignments is missing in scheduleData");
        return; // หยุดทำงานถ้าไม่มีข้อมูล
    }
    // --- จบการตรวจสอบ ---

    // --- สร้าง Lookup เหตุผลการลา (ประกาศตรงนี้ ถูกต้อง) ---
    const absenceReasons = {}; // <-- *** ตรวจสอบการประกาศตรงนี้ ***
    if (scheduleData.teacherSchedule) {
        scheduleData.teacherSchedule.forEach(entry => {
            absenceReasons[entry.tutorName] = entry.reason; // <-- *** ตรวจสอบการกำหนดค่าตรงนี้ ***
        });
    }
    // --- จบส่วนสร้าง Lookup เหตุผล ---


    // 2. สร้างข้อมูลคาบสอนแทน + เก็บเหตุผลการเลือก
    const subsByTeacher = {};
    const actualAbsentTeacherLookup = {}; // **ย้าย Lookup นี้มาสร้างตรงนี้ด้วย**
    if (scheduleData.teacherSchedule) {
        scheduleData.teacherSchedule.forEach(entry => {
            const tutorWhoIsAbsent = entry.tutorName;
            entry.substitutions.forEach(sub => {
                const grade = sub.classInfo.split('/')[0];
                const key = `${sub.period}_${grade}`;
                actualAbsentTeacherLookup[key] = tutorWhoIsAbsent;
            });
        });
    }


    for (let period = 1; period <= 6; period++) {
        if (finalAssignments[period]) {
            for (const grade in finalAssignments[period]) {
                const assignment = finalAssignments[period][grade];
                const isSubstitute = assignment && assignment.teacher && assignment.teacher !== assignment.originalTeacher;

                if (isSubstitute) {
                    const substituteTeacherName = assignment.teacher;
                    const lookupKey = `${period}_${grade}`;
                    const correctOriginalTeacher = actualAbsentTeacherLookup[lookupKey] || assignment.originalTeacher || 'ครูท่านเดิม'; // <-- ใช้งาน actualAbsentTeacherLookup ตรงนี้
                    const subChoiceReason = assignment.subChoiceReason || '';

                    if (!subsByTeacher[substituteTeacherName]) {
                        subsByTeacher[substituteTeacherName] = [];
                    }
                    subsByTeacher[substituteTeacherName].push({
                        period: period,
                        subject: assignment.subject,
                        grade: grade,
                        originalTeacher: correctOriginalTeacher,
                        subChoiceReason: subChoiceReason
                    });
                }
            }
        }
    }

    // 3. เรียงลำดับชื่อครูผู้สอนแทน A-Z
    const sortedSubstituteTeachers = Object.keys(subsByTeacher).sort((a, b) => a.localeCompare(b, 'th'));

    // 4. สร้าง HTML
    if (sortedSubstituteTeachers.length === 0) {
        substituteSummaryScheduleNoDataEl.textContent = 'ไม่มีการสอนแทนในวันนี้';
        substituteSummaryScheduleNoDataEl.classList.remove('hidden');
        return;
    }

    sortedSubstituteTeachers.forEach(teacherName => {
        const substituteSchedule = subsByTeacher[teacherName];
        substituteSchedule.sort((a, b) => a.period - b.period); // เรียงคาบ

        const teacherDiv = document.createElement('div');
        teacherDiv.className = "bg-blue-50 p-5 rounded-lg shadow-md border border-blue-200";

        // --- สร้าง Header พร้อมเหตุผล และ "คาบรวมสุดท้าย" (แก้ไขใหม่) ---
        const teacherHeader = document.createElement('h4');
        teacherHeader.className = "text-xl font-semibold text-blue-900 mb-3";

        // ดึงเหตุผลส่วนแรก (เช่น "ครูว่าง (คาบรวมน้อยสุด)")
        const firstReasonFull = substituteSchedule[0]?.subChoiceReason || '';
        const baseReasonMatch = firstReasonFull.match(/^(.*?)(?:, คาบรวม=\d+)?$/); // ดึงข้อความก่อน ", คาบรวม=..."
        const baseReasonText = baseReasonMatch ? baseReasonMatch[1] : ''; // ข้อความเหตุผลหลัก

        // ดึงคาบรวมสุดท้ายจาก scheduleData.teacherWorkloads
        const finalWorkload = scheduleData.teacherWorkloads?.[teacherName]?.total ?? '?'; // ใช้ ?? '?' ถ้าหาไม่เจอ

        teacherHeader.innerHTML = `
            ${teacherName}
            <span class="text-sm font-normal text-slate-600 ml-2">(${baseReasonText}, คาบรวม=${finalWorkload})</span>
        `;
        teacherDiv.appendChild(teacherHeader);
        // --- จบส่วน Header ---


        const classList = document.createElement('ul');
        classList.className = "list-none space-y-2";

        substituteSchedule.forEach(cls => {
            const listItem = document.createElement('li');
            listItem.className = "text-slate-800 text-base md:text-lg border-b border-blue-100 pb-1";

            const timeStr = PERIOD_TIMES[cls.period] || ''; //
            const originalTeacher = cls.originalTeacher;
            // --- ตรวจสอบการใช้งาน absenceReasons ตรงนี้ ---
            const absenceReasonFull = absenceReasons[originalTeacher] || '';

            let onetDetail = '';
            if (absenceReasonFull.includes('O-NET')) {
                if (absenceReasonFull.includes('ป.6')) {
                    onetDetail = '<span class="text-xs text-slate-500 ml-1">(ติว O-NET ป.6)</span>';
                } else if (absenceReasonFull.includes('ม.3')) {
                    onetDetail = '<span class="text-xs text-slate-500 ml-1">(ติว O-NET ม.3)</span>';
                }
            }

            listItem.innerHTML = `
                <strong class="text-blue-800 w-16 inline-block">คาบ ${cls.period}:</strong>
                <span class="mr-1">${cls.subject}</span>
                <span class="text-slate-600">(${cls.grade})</span>
                <span class="ml-2">→</span>
                <strong class="text-orange-600 ml-1">สอนแทน ${originalTeacher}</strong>
                ${onetDetail}
            `;
            classList.appendChild(listItem);
        });

        teacherDiv.appendChild(classList);
        substituteSummaryScheduleDetails.appendChild(teacherDiv);
    });
}
// *** จบฟังก์ชัน renderSubstitutionSchedule (แก้ไข V3 - แสดงคาบรวมสุดท้าย) ***

// Main function to generate and render both schedules
        function generateAndRenderAllSchedules() {
            const selectedDateValue = datePicker.value;
            const dateKey = formatDateToKey(selectedDateValue);
            currentFullSchedule = generateSchedules(dateKey); // Store the full results
			console.log('generateSchedules result:', currentFullSchedule);

            renderTeacherSchedule(currentFullSchedule);
            renderStudentSchedule(currentFullSchedule);

            // --- ส่วนที่เพิ่มเข้ามา ---
            // ตรวจสอบว่าแท็บ "ภาพรวม" กำลังเปิดอยู่หรือไม่
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab && activeTab.getAttribute('data-tab') === 'onet-overview') {
                // ถ้าใช่, สั่ง render ตารางภาพรวมใหม่ทันที
                renderOnetOverviewTable(dateKey); 
            }
			renderSubstitutionSchedule(currentFullSchedule);
        }
		
		// --- ฟังก์ชันสำหรับหมุนวนตารางติว (เพิ่มใหม่) ---
        function applyRotation(newIndex) {
            // 1. คำนวณ Index ใหม่ (วนลูป 0, 1, 2, 3)
            currentRotationIndex = (newIndex + 4) % 4; 
            
            // 2. อัปเดตข้อความแสดงสถานะ
            document.getElementById('rotation-status').textContent = `รูปแบบ ${currentRotationIndex + 1} / 4`;

            // 3. สร้างข้อมูล onetData ชุดใหม่ตามการหมุน
            const newOnetData = {};
            onetDateKeys.forEach((dateKey, index) => {
                const originalPatternIndex = index % 4; // วันที่นี้ควรจะเป็นรูปแบบที่เท่าไหร่ (0-3)
                const rotatedPatternIndex = (originalPatternIndex + currentRotationIndex) % 4; // รูปแบบใหม่ที่ถูกหมุนมา
                
                newOnetData[dateKey] = onetSchedulePatterns[rotatedPatternIndex];
            });

            // 4. สลับข้อมูล O-NET ให้เป็นชุดใหม่
            onetData = newOnetData;

            // 5. ล้าง Cache ข้อมูลเก่าทิ้ง
            workloadSummaryData = null;     //
            onetOverviewTableHTML = null;   //

            // 6. สั่ง Render แท็บรายวัน (สอนแทน, นักเรียน) ใหม่
            generateAndRenderAllSchedules();

            // 7. สั่ง Render แท็บสรุป/ภาพรวม (ถ้ากำลังเปิดอยู่)
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab && activeTab.getAttribute('data-tab') === 'onet-overview') {
                 renderOnetOverviewTable(dateKey); // <-- ส่ง dateKey เข้าไป
            }
            if (activeTab) {
                const activeTabId = activeTab.getAttribute('data-tab');
                
                if (activeTabId === 'summary') {
                    // บังคับคำนวณและแสดงผลแท็บสรุปใหม่
                    summaryHeaderEl.textContent = 'กำลังคำนวณข้อมูลสรุป...';
                    setTimeout(() => { // ใช้ setTimeout เพื่อให้ UI "กำลังคำนวณ" แสดงผลก่อน
                        workloadSummaryData = calculateWorkloadSummary("10/11/2568", "30/01/2569"); //
                        renderWorkloadSummary(workloadSummaryData); //
                    }, 50);
                } else if (activeTabId === 'onet-overview') {
                    // บังคับแสดงผลแท็บภาพรวมตารางติวใหม่
                    const selectedDateValue = datePicker.value;
                    const dateKey = formatDateToKey(selectedDateValue);
                    renderOnetOverviewTable(dateKey); // <-- ส่ง dateKey เข้าไป
                }
				else if (activeTabId === 'substitute-summary-schedule') { // <-- เพิ่มส่วนนี้
                // ถ้าแท็บสรุปการสอนแทนกำลังเปิดอยู่ ให้ render ใหม่
                renderSubstitutionSchedule(currentFullSchedule);
            }
            }
        }

// --- Tab Switching Logic ---
tabButtons.forEach(button => {
    button.addEventListener('click', () => {
        // Deactivate all buttons and content
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        // Activate clicked button and corresponding content
        button.classList.add('active');
        const tabId = button.getAttribute('data-tab');
        document.getElementById(tabId + '-content').classList.add('active');

        // --- LOGIC ที่เพิ่มเข้ามา ---
        // If the summary tab is clicked, calculate (if not already done) and render
        if (tabId === 'summary') {
            if (workloadSummaryData === null) {
                // Show a temporary loading message if needed
                summaryHeaderEl.textContent = 'กำลังคำนวณข้อมูลสรุป...';
                summaryScheduleDetails.innerHTML = '';

                // Run calculation (use setTimeout to allow UI to update)
                setTimeout(() => {
                    workloadSummaryData = calculateWorkloadSummary("10/11/2568", "30/01/2569"); //
                    renderWorkloadSummary(workloadSummaryData); //
                }, 50); // 50ms delay
            } else {
                // If data is already cached, just re-render it
                renderWorkloadSummary(workloadSummaryData); //
            }
        } else if (tabId === 'onet-overview') {
            // ฟังก์ชันนี้จะสร้างตารางพร้อมไฮไลต์
            const selectedDateValue = datePicker.value; //
            const dateKey = formatDateToKey(selectedDateValue); //
            renderOnetOverviewTable(dateKey); //
        } else if (tabId === 'substitute-summary-schedule') { // <-- ส่วนที่เพิ่มเข้ามา
             // ถ้ากดมาที่แท็บสรุปการสอนแทน
             if (currentFullSchedule) { // เช็คว่ามีข้อมูลตารางล่าสุดหรือยัง
                  renderSubstitutionSchedule(currentFullSchedule); // ให้ render ทันที
             }
             // (ถ้ายังไม่มี currentFullSchedule ไม่ต้องทำอะไร รอ generateAndRenderAllSchedules ทำงาน)
        }
    }); // <-- ปิด event listener ของปุ่ม
}); // <-- ปิด tabButtons.forEach


        // --- Event Listeners ---
        datePicker.addEventListener('change', generateAndRenderAllSchedules);
		prevRotationBtn.addEventListener('click', () => applyRotation(currentRotationIndex - 1));
        nextRotationBtn.addEventListener('click', () => applyRotation(currentRotationIndex + 1));
// --- Event Listener สำหรับ Export ภาพรวม (แก้ไข) ---
        exportCombinedBtn.addEventListener('click', async () => {
            const selectedDateValue = datePicker.value;
            const dateKey = formatDateToKey(selectedDateValue); //

            if (!currentFullSchedule || (!currentFullSchedule.teacherSchedule.length && !Object.values(currentFullSchedule.studentScheduleByGrade).some(g => g.filter(cls => cls.isSubstitute).length > 0))) {
                 showToast(`ไม่มีข้อมูลตารางเรียน/สอนแทนสำหรับ Export ในวันนี้`);
                 return;
            }

            // --- สร้าง Container ชั่วคราว (Off-screen) ---
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.width = '896px';
            tempContainer.style.padding = '32px';
            tempContainer.style.backgroundColor = '#ffffff';
            tempContainer.className = 'bg-white p-8'; // ใช้ class Tailwind

            // --- *** สร้างหัวข้อหลักเพียงอันเดียว *** ---
            const mainHeader = document.createElement('h3');
            mainHeader.className = "text-2xl font-bold text-center text-indigo-700 mb-6";
            // ดึงข้อความวันที่จาก Header ไหนก็ได้ (เช่น studentHeaderEl) มาใช้
            // หรือจะสร้างข้อความใหม่จาก currentFullSchedule ก็ได้
            mainHeader.innerHTML = `📅 ตารางเรียนและผลการสอนแทน ${currentFullSchedule.dayOfWeekText} ${currentFullSchedule.fullDateText}`; //
            tempContainer.appendChild(mainHeader);
            // --- *** จบส่วนหัวข้อหลัก *** ---

// --- 1. เพิ่มส่วนตารางเรียน (นักเรียน) - เพิ่ม Header ย่อย ---
            const studentHeaderSub = document.createElement('h3');
            studentHeaderSub.className = "text-xl font-semibold text-blue-800 mb-4 mt-6"; // เพิ่ม mt-6 เพื่อเว้นระยะจากหัวข้อหลัก
            studentHeaderSub.innerHTML = `🧑‍🎓 ตารางเรียน (เฉพาะคาบที่มีการสอนแทน)`;
            tempContainer.appendChild(studentHeaderSub);
            // --- จบการเพิ่ม Header ย่อย ---

            // --- 1. เพิ่มส่วนตารางเรียน (นักเรียน) - ไม่มี Header แล้ว ---
            const studentSubs = Object.values(currentFullSchedule.studentScheduleByGrade).flatMap(g => g.filter(cls => cls.isSubstitute));
            if (studentSubs.length > 0) {
                 // Clone เฉพาะส่วน Details
                 const studentDetailsClone = studentScheduleDetails.cloneNode(true); //
                 studentDetailsClone.id = ''; // ลบ ID
                 tempContainer.appendChild(studentDetailsClone);
            } else {
                 const noStudentData = document.createElement('p');
                 noStudentData.className = "text-center text-slate-500 text-xl font-medium py-8 border rounded-lg bg-blue-50 border-blue-200"; // เพิ่ม Style เล็กน้อย
                 noStudentData.textContent = "ไม่มีคาบเรียนที่มีการสอนแทนในวันนี้";
                 tempContainer.appendChild(noStudentData);
            }

            // --- เพิ่มเส้นคั่น ถ้ามีทั้งสองส่วน ---
            if (studentSubs.length > 0 && currentFullSchedule.teacherSchedule.length > 0) {
                 const hr = document.createElement('hr');
                 hr.className = 'mt-4 mb-8';
                 tempContainer.appendChild(hr);
            } else {
                 // ถ้ามีแค่ส่วนเดียว ให้เพิ่มระยะห่างด้านล่างแทนเส้นคั่น
                 tempContainer.lastChild.classList.add('mb-8');
            }

// --- 2. เพิ่มส่วนตารางสอนแทน (ครู) - เพิ่ม Header ย่อย ---
            const teacherHeaderSub = document.createElement('h3');
            teacherHeaderSub.className = "text-xl font-semibold text-indigo-800 mb-4"; // ไม่ต้องมี mt-6 เพราะมี hr หรือ mb-8 คั่นอยู่แล้ว
            teacherHeaderSub.innerHTML = `👩‍🏫 ผลการจัดตารางสอนแทน`;
            tempContainer.appendChild(teacherHeaderSub);
            // --- จบการเพิ่ม Header ย่อย ---

            // --- 2. เพิ่มส่วนตารางสอนแทน (ครู) - ไม่มี Header แล้ว ---
            if (currentFullSchedule.teacherSchedule.length > 0) {
                // Clone เฉพาะส่วน Details
                const teacherDetailsClone = teacherScheduleDetails.cloneNode(true); //
                teacherDetailsClone.id = ''; // ลบ ID
                tempContainer.appendChild(teacherDetailsClone);
            } else {
                 const noTeacherData = document.createElement('p');
                 noTeacherData.className = "text-center text-slate-500 text-xl font-medium py-8 border rounded-lg bg-slate-50 border-slate-200"; // เพิ่ม Style เล็กน้อย
                 noTeacherData.textContent = "ไม่มีการติว O-NET หรือไม่มีคาบสอนแทนในวันนี้";
                 tempContainer.appendChild(noTeacherData);
            }

            // --- เพิ่ม Container ชั่วคราวลงใน DOM ---
            document.body.appendChild(tempContainer);

            // --- 3. ใช้ html2canvas จับภาพ ---
            try {
                await new Promise(resolve => setTimeout(resolve, 100)); // รอ render

                const canvas = await html2canvas(tempContainer, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                const link = document.createElement('a');
                link.download = `ตารางรวม-${selectedDateValue}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();

            } catch (err) {
                console.error("Error exporting combined image:", err);
                showToast('เกิดข้อผิดพลาดในการ Export รูปภาพรวม');
            } finally {
                // --- 4. ลบ Container ชั่วคราว ---
                document.body.removeChild(tempContainer);
            }
        });
        // --- สิ้นสุด Event Listener ---
		
		shareCombinedBtn.addEventListener('click', async () => {
            const selectedDateValue = datePicker.value;
            const dateKey = formatDateToKey(selectedDateValue); //

            if (!currentFullSchedule || (!currentFullSchedule.teacherSchedule.length && !Object.values(currentFullSchedule.studentScheduleByGrade).some(g => g.filter(cls => cls.isSubstitute).length > 0))) {
                 showToast(`ไม่มีข้อมูลตารางเรียน/สอนแทนสำหรับแชร์ในวันนี้`);
                 return;
            }

            // --- สร้าง Container ชั่วคราว (เหมือน Export) ---
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.width = '896px';
            tempContainer.style.padding = '32px';
            tempContainer.style.backgroundColor = '#ffffff';
            tempContainer.className = 'bg-white p-8';

            // --- สร้างหัวข้อหลัก (เหมือน Export) ---
            const mainHeader = document.createElement('h3');
            mainHeader.className = "text-2xl font-bold text-center text-indigo-700 mb-6";
            mainHeader.innerHTML = `📅 ตารางเรียนและผลการสอนแทน ${currentFullSchedule.dayOfWeekText} ${currentFullSchedule.fullDateText}`; //
            tempContainer.appendChild(mainHeader);

            // --- เพิ่มหัวข้อย่อยและส่วนตารางเรียน (เหมือน Export) ---
            const studentHeaderSub = document.createElement('h3');
            studentHeaderSub.className = "text-xl font-semibold text-blue-800 mb-4 mt-6";
            studentHeaderSub.innerHTML = `🧑‍🎓 ตารางเรียน (เฉพาะคาบที่มีการสอนแทน)`;
            tempContainer.appendChild(studentHeaderSub);
            const studentSubs = Object.values(currentFullSchedule.studentScheduleByGrade).flatMap(g => g.filter(cls => cls.isSubstitute));
            if (studentSubs.length > 0) {
                 const studentDetailsClone = studentScheduleDetails.cloneNode(true); //
                 studentDetailsClone.id = '';
                 tempContainer.appendChild(studentDetailsClone);
            } else {
                 const noStudentData = document.createElement('p');
                 noStudentData.className = "text-center text-slate-500 text-xl font-medium py-8 border rounded-lg bg-blue-50 border-blue-200";
                 noStudentData.textContent = "ไม่มีคาบเรียนที่มีการสอนแทนในวันนี้";
                 tempContainer.appendChild(noStudentData);
            }

            // --- เพิ่มเส้นคั่น (เหมือน Export) ---
            if (studentSubs.length > 0 && currentFullSchedule.teacherSchedule.length > 0) {
                 const hr = document.createElement('hr');
                 hr.className = 'mt-4 mb-8'; // ใช้ margin ที่ปรับแล้ว
                 tempContainer.appendChild(hr);
            } else {
                 tempContainer.lastChild.classList.add('mb-8');
            }

            // --- เพิ่มหัวข้อย่อยและส่วนตารางสอนแทน (เหมือน Export) ---
            const teacherHeaderSub = document.createElement('h3');
            teacherHeaderSub.className = "text-xl font-semibold text-indigo-800 mb-4";
            teacherHeaderSub.innerHTML = `👩‍🏫 ผลการจัดตารางสอนแทน`;
            tempContainer.appendChild(teacherHeaderSub);
            if (currentFullSchedule.teacherSchedule.length > 0) {
                const teacherDetailsClone = teacherScheduleDetails.cloneNode(true); //
                teacherDetailsClone.id = '';
                tempContainer.appendChild(teacherDetailsClone);
            } else {
                 const noTeacherData = document.createElement('p');
                 noTeacherData.className = "text-center text-slate-500 text-xl font-medium py-8 border rounded-lg bg-slate-50 border-slate-200";
                 noTeacherData.textContent = "ไม่มีการติว O-NET หรือไม่มีคาบสอนแทนในวันนี้";
                 tempContainer.appendChild(noTeacherData);
            }

            // --- เพิ่ม Container ชั่วคราวลงใน DOM ---
            document.body.appendChild(tempContainer);

            // --- *** ใช้ html2canvas และ Web Share API *** ---
            try {
                await new Promise(resolve => setTimeout(resolve, 100)); // รอ render

                const canvas = await html2canvas(tempContainer, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });

                // แปลง canvas เป็น Blob
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        showToast('ไม่สามารถสร้างรูปภาพสำหรับแชร์ได้');
                        document.body.removeChild(tempContainer); // Clean up
                        return;
                    }
                    const fileName = `ตารางรวม-${selectedDateValue}.jpg`;
                    const file = new File([blob], fileName, { type: 'image/jpeg' });
                    const shareData = {
                        files: [file],
                        title: `ตารางรวมวันที่ ${selectedDateValue}`,
                        text: `ตารางเรียนและสอนแทนวันที่ ${selectedDateValue}`,
                    };

                    // ตรวจสอบว่าแชร์ได้ไหม
                    if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                        try {
                            await navigator.share(shareData);
                            console.log('Combined image shared successfully');
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.error('Share failed:', err.message);
                                showToast('การแชร์ไม่สำเร็จ กรุณาลอง Export แล้วแชร์ด้วยตนเอง');
                            } else {
                                console.log('Share cancelled by user');
                            }
                        }
                    } else {
                        console.warn('Cannot share files according to navigator.canShare or API not supported');
                        showToast('เบราว์เซอร์ไม่รองรับการแชร์ไฟล์รูปภาพโดยตรง กรุณาลอง Export แล้วแชร์ด้วยตนเอง');
                    }
                     // --- ลบ Container ชั่วคราว (หลังจากแชร์เสร็จ) ---
                    document.body.removeChild(tempContainer);

                }, 'image/jpeg', 0.9); // คุณภาพ 90%

            } catch (err) {
                console.error("Error generating or sharing combined image:", err);
                showToast('เกิดข้อผิดพลาดในการสร้างภาพสำหรับแชร์');
                 // --- ลบ Container ชั่วคราว (กรณีเกิด Error) ---
                if (document.body.contains(tempContainer)) {
                    document.body.removeChild(tempContainer);
                }
            }
            // ไม่ต้องมี finally เพราะการลบ container ถูกจัดการใน toBlob callback แล้ว
        });
		
        exportBtn.addEventListener('click', async () => {
             // Target the *currently active tab's content* for export
             const activeTabContent = document.querySelector('.tab-content.active');
             // Determine which no-data element corresponds to the active tab
// Determine which no-data element corresponds to the active tab
let exportFileNamePrefix = 'ตาราง';
            let noDataCheckElement = null;
            let scheduleCheck = currentFullSchedule; // ค่าเริ่มต้นสำหรับเช็คข้อมูล

            if (activeTabContent.id === 'teacher-schedule-content') {
                exportFileNamePrefix = 'ตารางสอนแทน';
                noDataCheckElement = teacherNoDataEl;
            } else if (activeTabContent.id === 'student-schedule-content') {
                exportFileNamePrefix = 'ตารางเรียน';
                noDataCheckElement = studentNoDataEl;
            } else if (activeTabContent.id === 'summary-content') {
                exportFileNamePrefix = 'สรุปชั่วโมงสอน';
                noDataCheckElement = summaryNoDataEl;
                scheduleCheck = workloadSummaryData; // เปลี่ยนไปเช็ค cache ของ summary
            } else if (activeTabContent.id === 'onet-overview-content') {
                exportFileNamePrefix = 'ภาพรวมตารางติว';
                noDataCheckElement = onetOverviewNoDataEl;
                scheduleCheck = onetOverviewTableHTML; // เปลี่ยนไปเช็ค cache ของ overview
            } else if (activeTabContent.id === 'substitute-summary-schedule-content') { // <-- *** เพิ่มส่วนนี้ ***
         exportFileNamePrefix = 'สรุปการสอนแทน';
         noDataCheckElement = substituteSummaryScheduleNoDataEl; // อ้างอิง p id ที่ถูกต้อง
         scheduleCheck = currentFullSchedule; // แท็บนี้ใช้ข้อมูลหลัก
     }

            // ตรวจสอบว่าข้อมูลของแท็บนั้นโหลดมาหรือยัง
            if (!scheduleCheck) {
                showToast(`ไม่มี${exportFileNamePrefix}ให้ Export (ยังไม่โหลด)`);
                return;
            }
            
            // ตรวจสอบว่าแท็บนั้นแสดง "ไม่มีข้อมูล" หรือไม่
            if (noDataCheckElement && noDataCheckElement.offsetParent !== null ) { 
                showToast(`ไม่มี${exportFileNamePrefix}ให้ Export (ไม่มีข้อมูล)`);
                return;
            }

            try {
                const canvas = await html2canvas(activeTabContent, { // Capture the active tab content
                    scale: 3,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                const link = document.createElement('a');
                link.download = `${exportFileNamePrefix}-${datePicker.value}.jpg`; // Dynamic filename
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();

            } catch (err) {
                console.error("Error exporting image:", err);
                showToast('เกิดข้อผิดพลาดในการ Export รูปภาพ');
            }
        });

        shareBtn.addEventListener('click', async () => {
// Target the *currently active tab's content* for sharing
             const activeTabContent = document.querySelector('.tab-content.active');
            const dateValue = datePicker.value; // เก็บไว้ใช้
            
            let shareTitlePrefix = 'ตาราง';
            let noDataCheckElement = null;
            let scheduleCheck = currentFullSchedule; // ค่าเริ่มต้นสำหรับเช็คข้อมูล

            if (activeTabContent.id === 'teacher-schedule-content') {
                shareTitlePrefix = 'ตารางสอนแทน';
                noDataCheckElement = teacherNoDataEl;
            } else if (activeTabContent.id === 'student-schedule-content') {
                shareTitlePrefix = 'ตารางเรียน';
                noDataCheckElement = studentNoDataEl;
            } else if (activeTabContent.id === 'summary-content') {
                shareTitlePrefix = 'สรุปชั่วโมงสอน';
                noDataCheckElement = summaryNoDataEl;
                scheduleCheck = workloadSummaryData; // เปลี่ยนไปเช็ค cache ของ summary
            } else if (activeTabContent.id === 'onet-overview-content') {
                shareTitlePrefix = 'ภาพรวมตารางติว';
                noDataCheckElement = onetOverviewNoDataEl;
                scheduleCheck = onetOverviewTableHTML; // เปลี่ยนไปเช็ค cache ของ overview
            } else if (activeTabContent.id === 'substitute-summary-schedule-content') { // <-- *** เพิ่มส่วนนี้ ***
         shareTitlePrefix = 'สรุปการสอนแทน';
         noDataCheckElement = substituteSummaryScheduleNoDataEl; // อ้างอิง p id ที่ถูกต้อง
         scheduleCheck = currentFullSchedule; // แท็บนี้ใช้ข้อมูลหลัก
     }

            // ตรวจสอบว่าข้อมูลของแท็บนั้นโหลดมาหรือยัง
            if (!scheduleCheck) {
                showToast(`ไม่มี${shareTitlePrefix}ให้แชร์ (ยังไม่โหลด)`);
                return;
            }
            
            // ตรวจสอบว่าแท็บนั้นแสดง "ไม่มีข้อมูล" หรือไม่
            if (noDataCheckElement && noDataCheckElement.offsetParent !== null ) { 
                showToast(`ไม่มี${shareTitlePrefix}ให้แชร์ (ไม่มีข้อมูล)`);
                return;
            }

             try {
                const canvas = await html2canvas(activeTabContent, { // Capture active tab
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true
                });

                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        showToast('ไม่สามารถสร้างรูปภาพได้');
                        return;
                    }
                    const fileName = `${shareTitlePrefix}-${dateValue}.jpg`; // Dynamic filename
                    const file = new File([blob], fileName, { type: 'image/jpeg' });
                    const shareData = {
                        files: [file],
                        title: `${shareTitlePrefix}วันที่ ${dateValue}`, // Dynamic title
                        text: `${shareTitlePrefix}วันที่ ${dateValue}`, // Dynamic text
                    };

                    if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                        try {
                            await navigator.share(shareData);
                            console.log('Image shared successfully');
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.error('Share failed:', err.message);
                                showToast('การแชร์ไม่สำเร็จ กรุณา Export แล้วแชร์ด้วยตนเอง');
                            } else {
                                console.log('Share cancelled by user');
                            }
                        }
                    } else {
                        console.warn('Cannot share files according to navigator.canShare or API not supported');
                        showToast('เบราว์เซอร์ไม่รองรับการแชร์ไฟล์รูปภาพโดยตรง กรุณา Export แล้วแชร์ด้วยตนเอง');
                    }
                }, 'image/jpeg', 0.9);

            } catch (err) {
                console.error('Error generating or sharing image:', err);
                showToast('เกิดข้อผิดพลาดในการแชร์รูปภาพ กรุณา Export แล้วแชร์ด้วยตนเอง');
            }
        });


        // Fallback copy function (not used for image share)
        function copyUsingExecCommand(text) {
             const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('คัดลอกลิงก์ไปยังคลิปบอร์ดแล้ว');
                } else {
                     showToast('ไม่สามารถคัดลอกได้');
                }
            } catch (err) {
                 console.error('Fallback: Oops, unable to copy', err);
                 showToast('ไม่สามารถคัดลอกได้');
            }
            document.body.removeChild(textArea);
        }

// --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. ตั้งค่าวันที่เป็นวันปัจจุบัน ---
            const today = new Date();
            const yyyy = today.getFullYear();
            // getMonth() คืนค่า 0-11 จึงต้อง +1 และ padStart(2, '0') เพื่อให้เป็น 01, 02, ..., 12
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            // getDate() คืนค่า 1-31 และ padStart(2, '0') เพื่อให้เป็น 01, 02, ...
            const dd = String(today.getDate()).padStart(2, '0');
            
            // Format: YYYY-MM-DD
            datePicker.value = `${yyyy}-${mm}-${dd}`;
            // --- จบส่วนที่ 1 ---

            // 2. โหลดข้อมูลตามปกติ
            generateAndRenderAllSchedules(); 
        });

    </script>

</body>
</html>

